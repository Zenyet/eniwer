import{a as G,b as se,D as I,i as C,c as x}from"../chunks/types.js";const S="thecircle_data";async function Y(){const e=await chrome.storage.local.get(S);return e[S]?e[S]:{config:I,selectionMenuItems:se,globalMenuItems:G}}async function ee(e){const o={...await Y(),...e};await chrome.storage.local.set({[S]:o})}async function X(e){const t=await Y();t.config={...t.config,...e},await ee(t)}async function Z(e){await ee({globalMenuItems:e})}let u=[],A=null;document.addEventListener("DOMContentLoaded",async()=>{var W;const e=document.getElementById("app-logo");e&&(e.innerHTML=C.logo);const t=document.getElementById("apiProvider"),o=document.getElementById("apiKey"),r=document.getElementById("customApiUrl"),n=document.getElementById("customModel"),s=document.getElementById("customApiUrlGroup"),a=document.getElementById("customModelGroup"),c=document.getElementById("apiKeyHelpText"),m=document.getElementById("useStreaming"),g=document.getElementById("preferredLanguage"),y=document.getElementById("popoverPosition"),k=document.getElementById("theme"),h=document.getElementById("saveBtn"),d=document.getElementById("resetBtn"),v=document.getElementById("shortcutDisplay"),w=document.getElementById("recordShortcutBtn"),V=document.getElementById("shortcutHelpText"),P=document.getElementById("screenshotSaveToFile"),U=document.getElementById("screenshotCopyToClipboard"),D=document.getElementById("screenshotEnableAI"),$=document.getElementById("screenshotDefaultAIAction"),K=document.getElementById("screenshotEnableImageGen"),L=document.getElementById("imageGenProvider"),F=document.getElementById("customImageGenUrl"),oe=document.getElementById("customImageGenUrlGroup"),q=document.getElementById("imageSize");let H=!1,B="Alt+Tab";const Q=await Y(),p=Q.config,E=p.screenshot||x;u=Q.globalMenuItems,u=ae(u,G),t.value=p.apiProvider,o.value=p.apiKey||"",r.value=p.customApiUrl||"",n.value=p.customModel||"",m.checked=p.useStreaming??!0,g.value=p.preferredLanguage,y.value=p.popoverPosition||"above",k.value=p.theme,B=p.shortcut||"Alt+Tab",R(B),O(p.apiProvider),P.checked=E.saveToFile,U.checked=E.copyToClipboard,D.checked=E.enableAI,$.value=E.defaultAIAction,K.checked=E.enableImageGen,L.value=E.imageGenProvider,F.value=E.customImageGenUrl||"",q.value=E.imageSize,_(E.imageGenProvider),T("globalMenuList",u),ue(),z(p.theme),(W=document.getElementById("addGlobalItem"))==null||W.addEventListener("click",()=>{A=null,te("添加自定义菜单项")}),t.addEventListener("change",()=>{O(t.value)});function O(l){const i=l==="custom";s.style.display=i?"block":"none",a.style.display=i?"block":"none",l==="groq"?c.textContent="使用 Groq 免费服务无需配置 API Key":i?c.textContent="如果你的 API 需要认证，请填写 API Key":c.textContent=`请填写你的 ${l.toUpperCase()} API Key`}function _(l){const i=l==="custom";oe.style.display=i?"block":"none"}L==null||L.addEventListener("change",()=>{_(L.value)}),w==null||w.addEventListener("click",()=>{H?N():ne()});function ne(){H=!0,w.textContent="取消录制",w.classList.add("bg-red-500/20","border-red-500","text-red-400"),v.classList.add("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),V.textContent="请按下快捷键组合... (ESC 取消)",document.addEventListener("keydown",J)}function N(){H=!1,w.textContent="录制快捷键",w.classList.remove("bg-red-500/20","border-red-500","text-red-400"),v.classList.remove("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),V.textContent='点击"录制快捷键"按钮，然后按下你想要的快捷键组合',document.removeEventListener("keydown",J)}function J(l){if(l.preventDefault(),l.stopPropagation(),l.key==="Escape"){N();return}const i=[];(l.ctrlKey||l.metaKey)&&i.push("Ctrl"),l.altKey&&i.push("Alt"),l.shiftKey&&i.push("Shift");const f=l.key;if(!["Control","Alt","Shift","Meta"].includes(f)){const j=f===" "?"Space":f.length===1?f.toUpperCase():f;i.push(j),i.length>=2&&(B=i.join("+"),R(B),N(),b("快捷键已设置，请点击保存按钮"))}}function R(l){if(v){const i=l.split("+");v.innerHTML=i.map((f,j)=>{const re=j<i.length-1?'<span class="text-base text-white/50">+</span>':"";return`<span class="px-4 py-2 rounded-md text-sm font-semibold bg-white/10 border border-white/20">${f}</span>${re}`}).join("")}}h==null||h.addEventListener("click",async()=>{const l=t.value;if(l==="custom"){if(!r.value){b("请填写自定义 API URL","error");return}if(!n.value){b("请填写模型名称","error");return}try{new URL(r.value)}catch{b("API URL 格式不正确","error");return}}const i={saveToFile:P.checked,copyToClipboard:U.checked,enableAI:D.checked,defaultAIAction:$.value,imageQuality:.92,enableImageGen:K.checked,imageGenProvider:L.value,customImageGenUrl:F.value||void 0,imageSize:q.value},f={apiProvider:l,apiKey:o.value||void 0,customApiUrl:r.value||void 0,customModel:n.value||void 0,useStreaming:m.checked,preferredLanguage:g.value,popoverPosition:y.value,theme:k.value,shortcut:B,screenshot:i};z(f.theme),await X(f),await Z(u),b("设置已保存","success")}),d==null||d.addEventListener("click",async()=>{await X(I),await Z(G),t.value=I.apiProvider,o.value="",r.value="",n.value="",m.checked=I.useStreaming,g.value=I.preferredLanguage,y.value=I.popoverPosition||"above",k.value=I.theme,z(I.theme),B=I.shortcut,R(B),O(I.apiProvider),P.checked=x.saveToFile,U.checked=x.copyToClipboard,D.checked=x.enableAI,$.value=x.defaultAIAction,K.checked=x.enableImageGen,L.value=x.imageGenProvider,F.value="",q.value=x.imageSize,_(x.imageGenProvider),u=[...G],T("globalMenuList",u),b("已重置为默认设置","success")})});function ae(e,t){return e.map((o,r)=>{const n=t.find(s=>s.id===o.id);return{...o,enabled:o.enabled??!0,order:o.order??(n==null?void 0:n.order)??r}})}function T(e,t){const o=document.getElementById(e);if(!o)return;const r=[...t].sort((n,s)=>n.order-s.order);o.innerHTML=r.map(n=>{const s=n.isCustom;return`
      <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white border border-gray-200 dark:bg-white/5 dark:border-white/10 transition-all duration-150 cursor-grab hover:bg-gray-50 hover:border-gray-300 dark:hover:bg-white/10 dark:hover:border-white/15 menu-item-config" draggable="true" data-id="${n.id}">
        <span class="text-sm cursor-grab text-gray-400 dark:text-white/30 select-none tracking-widest hover:text-gray-600 dark:hover:text-white/50 drag-handle">⋮⋮</span>
        <span class="flex items-center justify-center w-[28px] h-[28px] rounded-md bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-white/80 item-icon">${n.customIcon||n.icon}</span>
        <span class="flex-1 text-sm font-medium text-gray-900 dark:text-white/90 item-label">${n.customLabel||n.label}</span>
        <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-white/50 item-action">${n.action}</span>
        <div class="flex items-center gap-2 item-actions">
          ${s?`
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-gray-900 hover:bg-gray-100 dark:text-white/40 dark:hover:bg-white/10 dark:hover:text-white/80 item-btn edit" data-id="${n.id}" title="编辑">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
              </svg>
            </button>
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-red-600 hover:bg-red-50 dark:text-white/40 dark:hover:bg-red-500/20 dark:hover:text-red-500 item-btn delete" data-id="${n.id}" title="删除">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          `:""}
          <label class="relative inline-block w-[36px] h-[20px] toggle-switch small">
            <input type="checkbox" ${n.enabled?"checked":""} data-id="${n.id}" class="opacity-0 w-0 h-0 peer sr-only">
            <span class="absolute inset-0 cursor-pointer rounded-full bg-gray-200 dark:bg-white/15 transition-all duration-250 before:absolute before:rounded-full before:h-[14px] before:w-[14px] before:left-[3px] before:bottom-[3px] before:bg-white dark:before:bg-white/70 before:transition-all before:duration-250 peer-checked:bg-blue-500 peer-checked:before:translate-x-[16px] peer-checked:before:bg-white toggle-slider"></span>
          </label>
        </div>
      </div>
    `}).join(""),ce(e),de(e),ie(e)}function ce(e){const t=document.getElementById(e);if(!t)return;const o=t.querySelectorAll(".menu-item-config");let r=null;o.forEach(n=>{const s=n;s.addEventListener("dragstart",a=>{r=s,setTimeout(()=>s.classList.add("opacity-50","cursor-grabbing","dragging","scale-95"),0),a.dataTransfer.effectAllowed="move"}),s.addEventListener("dragend",()=>{s.classList.remove("opacity-50","cursor-grabbing","dragging","scale-95"),r=null,le(e)}),s.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer.dropEffect="move",s.classList.add("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("dragleave",()=>{s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("drop",a=>{if(a.preventDefault(),s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over"),r&&r!==s){const c=s.getBoundingClientRect(),m=c.top+c.height/2;a.clientY<m?t.insertBefore(r,s):t.insertBefore(r,s.nextSibling)}})})}function le(e){const t=document.getElementById(e);if(!t)return;t.querySelectorAll(".menu-item-config").forEach((r,n)=>{const s=r.dataset.id,a=u.find(c=>c.id===s);a&&(a.order=n)})}function de(e){const t=document.getElementById(e);if(!t)return;t.querySelectorAll(".toggle-switch input").forEach(r=>{r.addEventListener("change",n=>{const s=n.target,a=s.dataset.id,c=u.find(m=>m.id===a);c&&(c.enabled=s.checked)})})}function ie(e){const t=document.getElementById(e);t&&(t.querySelectorAll(".item-btn.edit").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.id;if(r){A=r;const n=u.find(s=>s.id===r);n&&te("编辑自定义菜单项",n)}})}),t.querySelectorAll(".item-btn.delete").forEach(o=>{o.addEventListener("click",()=>{const r=o.dataset.id;r&&(u=u.filter(n=>n.id!==r),T("globalMenuList",u),b("菜单项已删除"))})}))}function ue(){const e=document.getElementById("customItemModal"),t=document.getElementById("modalClose"),o=document.getElementById("cancelCustomItem"),r=document.getElementById("saveCustomItem"),n=document.getElementById("customItemAction"),s=document.getElementById("customPromptGroup"),a=document.getElementById("customUrlGroup");me(),t==null||t.addEventListener("click",M),o==null||o.addEventListener("click",M),e==null||e.addEventListener("click",c=>{c.target===e&&M()}),n==null||n.addEventListener("change",()=>{const c=n.value;s&&(s.style.display=c==="customAI"?"block":"none"),a&&(a.style.display=c==="openUrl"?"block":"none")}),r==null||r.addEventListener("click",()=>{const c=document.getElementById("selectedIcon").value,m=document.getElementById("customItemLabel").value.trim(),g=document.getElementById("customItemAction").value,y=document.getElementById("customPrompt").value.trim(),k=document.getElementById("customUrl").value.trim();if(!c){b("请选择一个图标","error");return}if(!m){b("请输入菜单项名称","error");return}if(g==="customAI"&&!y){b("请输入 AI 提示词","error");return}if(g==="openUrl"&&!k){b("请输入链接地址","error");return}const h=C[c];if(A){const d=u.find(v=>v.id===A);d&&(d.icon=h,d.label=m,d.action=g,g==="customAI"&&(d.customPrompt=y))}else{const d={id:`custom_${Date.now()}`,icon:h,label:m,action:g,enabled:!0,order:u.length,isCustom:!0,customPrompt:g==="customAI"?y:void 0};u.push(d)}T("globalMenuList",u),M(),b(A?"菜单项已更新":"菜单项已添加","success")})}function me(){const e=document.getElementById("iconPicker");if(!e)return;const t=Object.keys(C);e.innerHTML=t.map(o=>`
    <div class="flex items-center justify-center w-9 h-9 rounded-lg cursor-pointer bg-white/5 border-2 border-transparent text-white/70 transition-all duration-150 hover:bg-white/10 hover:text-white/90 icon-option" data-icon="${o}" title="${o}">
      ${C[o]}
    </div>
  `).join(""),e.querySelectorAll(".icon-option").forEach(o=>{o.addEventListener("click",()=>{e.querySelectorAll(".icon-option").forEach(r=>r.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),o.classList.add("border-blue-500","bg-blue-500/20","text-white","selected"),document.getElementById("selectedIcon").value=o.dataset.icon||""})})}function te(e,t){var k;const o=document.getElementById("customItemModal"),r=document.getElementById("modalTitle"),n=document.getElementById("selectedIcon"),s=document.getElementById("customItemLabel"),a=document.getElementById("customItemAction"),c=document.getElementById("customPrompt"),m=document.getElementById("customUrl"),g=document.getElementById("customPromptGroup"),y=document.getElementById("customUrlGroup");if(r&&(r.textContent=e),t){const h=((k=Object.entries(C).find(([d,v])=>v===t.icon))==null?void 0:k[0])||"";n.value=h,document.querySelectorAll(".icon-option").forEach(d=>{const v=d.dataset.icon===h;d.classList.toggle("selected",v),v?d.classList.add("border-blue-500","bg-blue-500/20","text-white"):d.classList.remove("border-blue-500","bg-blue-500/20","text-white")}),s.value=t.label,a.value=t.action,c.value=t.customPrompt||""}else n.value="",document.querySelectorAll(".icon-option").forEach(h=>h.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),s.value="",a.value="customAI",c.value="",m.value="";g&&(g.style.display=a.value==="customAI"?"block":"none"),y&&(y.style.display=a.value==="openUrl"?"block":"none"),o==null||o.classList.add("show")}function M(){const e=document.getElementById("customItemModal");e==null||e.classList.remove("show"),A=null}function z(e){const t=e==="dark"||e==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.classList.toggle("dark",t)}function b(e,t="success"){const o=document.getElementById("toast");if(o){o.textContent=e;const r=t==="success"?"border-green-500/50":"border-red-500/50";o.className=`fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 bg-[#1e1e1e]/95 border text-white/90 shadow-lg transition-all duration-250 backdrop-blur-sm z-[2000] opacity-100 translate-y-0 ${r}`,setTimeout(()=>{o.className="fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 translate-y-[100px] bg-[#1e1e1e]/95 border border-white/15 text-white/90 shadow-lg opacity-0 transition-all duration-250 backdrop-blur-sm z-[2000]"},2500)}}
