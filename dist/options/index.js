import{a as C,b as re,D as I,c as x,i as M}from"../chunks/types.js";const G="thecircle_data";async function z(){const e=await chrome.storage.local.get(G);return e[G]?e[G]:{config:I,selectionMenuItems:re,globalMenuItems:C}}async function Z(e){const t={...await z(),...e};await chrome.storage.local.set({[G]:t})}async function W(e){const o=await z();o.config={...o.config,...e},await Z(o)}async function X(e){await Z({globalMenuItems:e})}let u=[],B=null;document.addEventListener("DOMContentLoaded",async()=>{var J;const e=document.getElementById("apiProvider"),o=document.getElementById("apiKey"),t=document.getElementById("customApiUrl"),r=document.getElementById("customModel"),n=document.getElementById("customApiUrlGroup"),s=document.getElementById("customModelGroup"),a=document.getElementById("apiKeyHelpText"),c=document.getElementById("useStreaming"),g=document.getElementById("preferredLanguage"),p=document.getElementById("popoverPosition"),y=document.getElementById("theme"),k=document.getElementById("saveBtn"),v=document.getElementById("resetBtn"),d=document.getElementById("shortcutDisplay"),m=document.getElementById("recordShortcutBtn"),Y=document.getElementById("shortcutHelpText"),T=document.getElementById("screenshotSaveToFile"),P=document.getElementById("screenshotCopyToClipboard"),U=document.getElementById("screenshotEnableAI"),D=document.getElementById("screenshotDefaultAIAction"),$=document.getElementById("screenshotEnableImageGen"),w=document.getElementById("imageGenProvider"),K=document.getElementById("customImageGenUrl"),te=document.getElementById("customImageGenUrlGroup"),F=document.getElementById("imageSize");let q=!1,L="Alt+Tab";const V=await z(),b=V.config,E=b.screenshot||x;u=V.globalMenuItems,u=se(u,C),e.value=b.apiProvider,o.value=b.apiKey||"",t.value=b.customApiUrl||"",r.value=b.customModel||"",c.checked=b.useStreaming??!0,g.value=b.preferredLanguage,p.value=b.popoverPosition||"above",y.value=b.theme,L=b.shortcut||"Alt+Tab",N(L),O(b.apiProvider),T.checked=E.saveToFile,P.checked=E.copyToClipboard,U.checked=E.enableAI,D.value=E.defaultAIAction,$.checked=E.enableImageGen,w.value=E.imageGenProvider,K.value=E.customImageGenUrl||"",F.value=E.imageSize,_(E.imageGenProvider),S("globalMenuList",u),ie(),j(b.theme),(J=document.getElementById("addGlobalItem"))==null||J.addEventListener("click",()=>{B=null,ee("添加自定义菜单项")}),e.addEventListener("change",()=>{O(e.value)});function O(l){const i=l==="custom";n.style.display=i?"block":"none",s.style.display=i?"block":"none",l==="groq"?a.textContent="使用 Groq 免费服务无需配置 API Key":i?a.textContent="如果你的 API 需要认证，请填写 API Key":a.textContent=`请填写你的 ${l.toUpperCase()} API Key`}function _(l){const i=l==="custom";te.style.display=i?"block":"none"}w==null||w.addEventListener("change",()=>{_(w.value)}),m==null||m.addEventListener("click",()=>{q?H():oe()});function oe(){q=!0,m.textContent="取消录制",m.classList.add("bg-red-500/20","border-red-500","text-red-400"),d.classList.add("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),Y.textContent="请按下快捷键组合... (ESC 取消)",document.addEventListener("keydown",Q)}function H(){q=!1,m.textContent="录制快捷键",m.classList.remove("bg-red-500/20","border-red-500","text-red-400"),d.classList.remove("border-2","border-blue-500","bg-blue-500/10","animate-pulse"),Y.textContent='点击"录制快捷键"按钮，然后按下你想要的快捷键组合',document.removeEventListener("keydown",Q)}function Q(l){if(l.preventDefault(),l.stopPropagation(),l.key==="Escape"){H();return}const i=[];(l.ctrlKey||l.metaKey)&&i.push("Ctrl"),l.altKey&&i.push("Alt"),l.shiftKey&&i.push("Shift");const f=l.key;if(!["Control","Alt","Shift","Meta"].includes(f)){const R=f===" "?"Space":f.length===1?f.toUpperCase():f;i.push(R),i.length>=2&&(L=i.join("+"),N(L),H(),h("快捷键已设置，请点击保存按钮"))}}function N(l){if(d){const i=l.split("+");d.innerHTML=i.map((f,R)=>{const ne=R<i.length-1?'<span class="text-base text-white/50">+</span>':"";return`<span class="px-4 py-2 rounded-md text-sm font-semibold bg-white/10 border border-white/20">${f}</span>${ne}`}).join("")}}k==null||k.addEventListener("click",async()=>{const l=e.value;if(l==="custom"){if(!t.value){h("请填写自定义 API URL","error");return}if(!r.value){h("请填写模型名称","error");return}try{new URL(t.value)}catch{h("API URL 格式不正确","error");return}}const i={saveToFile:T.checked,copyToClipboard:P.checked,enableAI:U.checked,defaultAIAction:D.value,imageQuality:.92,enableImageGen:$.checked,imageGenProvider:w.value,customImageGenUrl:K.value||void 0,imageSize:F.value},f={apiProvider:l,apiKey:o.value||void 0,customApiUrl:t.value||void 0,customModel:r.value||void 0,useStreaming:c.checked,preferredLanguage:g.value,popoverPosition:p.value,theme:y.value,shortcut:L,screenshot:i};j(f.theme),await W(f),await X(u),h("设置已保存","success")}),v==null||v.addEventListener("click",async()=>{await W(I),await X(C),e.value=I.apiProvider,o.value="",t.value="",r.value="",c.checked=I.useStreaming,g.value=I.preferredLanguage,p.value=I.popoverPosition||"above",y.value=I.theme,j(I.theme),L=I.shortcut,N(L),O(I.apiProvider),T.checked=x.saveToFile,P.checked=x.copyToClipboard,U.checked=x.enableAI,D.value=x.defaultAIAction,$.checked=x.enableImageGen,w.value=x.imageGenProvider,K.value="",F.value=x.imageSize,_(x.imageGenProvider),u=[...C],S("globalMenuList",u),h("已重置为默认设置","success")})});function se(e,o){return e.map((t,r)=>{const n=o.find(s=>s.id===t.id);return{...t,enabled:t.enabled??!0,order:t.order??(n==null?void 0:n.order)??r}})}function S(e,o){const t=document.getElementById(e);if(!t)return;const r=[...o].sort((n,s)=>n.order-s.order);t.innerHTML=r.map(n=>{const s=n.isCustom;return`
      <div class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white border border-gray-200 dark:bg-white/5 dark:border-white/10 transition-all duration-150 cursor-grab hover:bg-gray-50 hover:border-gray-300 dark:hover:bg-white/10 dark:hover:border-white/15 menu-item-config" draggable="true" data-id="${n.id}">
        <span class="text-sm cursor-grab text-gray-400 dark:text-white/30 select-none tracking-widest hover:text-gray-600 dark:hover:text-white/50 drag-handle">⋮⋮</span>
        <span class="flex items-center justify-center w-[28px] h-[28px] rounded-md bg-gray-100 text-gray-700 dark:bg-white/10 dark:text-white/80 item-icon">${n.customIcon||n.icon}</span>
        <span class="flex-1 text-sm font-medium text-gray-900 dark:text-white/90 item-label">${n.customLabel||n.label}</span>
        <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-500 dark:bg-white/10 dark:text-white/50 item-action">${n.action}</span>
        <div class="flex items-center gap-2 item-actions">
          ${s?`
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-gray-900 hover:bg-gray-100 dark:text-white/40 dark:hover:bg-white/10 dark:hover:text-white/80 item-btn edit" data-id="${n.id}" title="编辑">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
              </svg>
            </button>
            <button class="p-1.5 rounded cursor-pointer border-none bg-transparent text-gray-400 hover:text-red-600 hover:bg-red-50 dark:text-white/40 dark:hover:bg-red-500/20 dark:hover:text-red-500 item-btn delete" data-id="${n.id}" title="删除">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          `:""}
          <label class="relative inline-block w-[36px] h-[20px] toggle-switch small">
            <input type="checkbox" ${n.enabled?"checked":""} data-id="${n.id}" class="opacity-0 w-0 h-0 peer sr-only">
            <span class="absolute inset-0 cursor-pointer rounded-full bg-gray-200 dark:bg-white/15 transition-all duration-250 before:absolute before:rounded-full before:h-[14px] before:w-[14px] before:left-[3px] before:bottom-[3px] before:bg-white dark:before:bg-white/70 before:transition-all before:duration-250 peer-checked:bg-blue-500 peer-checked:before:translate-x-[16px] peer-checked:before:bg-white toggle-slider"></span>
          </label>
        </div>
      </div>
    `}).join(""),ae(e),le(e),de(e)}function ae(e){const o=document.getElementById(e);if(!o)return;const t=o.querySelectorAll(".menu-item-config");let r=null;t.forEach(n=>{const s=n;s.addEventListener("dragstart",a=>{r=s,setTimeout(()=>s.classList.add("opacity-50","cursor-grabbing","dragging","scale-95"),0),a.dataTransfer.effectAllowed="move"}),s.addEventListener("dragend",()=>{s.classList.remove("opacity-50","cursor-grabbing","dragging","scale-95"),r=null,ce(e)}),s.addEventListener("dragover",a=>{a.preventDefault(),a.dataTransfer.dropEffect="move",s.classList.add("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("dragleave",()=>{s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over")}),s.addEventListener("drop",a=>{if(a.preventDefault(),s.classList.remove("border-blue-500/50","bg-blue-500/10","drag-over"),r&&r!==s){const c=s.getBoundingClientRect(),g=c.top+c.height/2;a.clientY<g?o.insertBefore(r,s):o.insertBefore(r,s.nextSibling)}})})}function ce(e){const o=document.getElementById(e);if(!o)return;o.querySelectorAll(".menu-item-config").forEach((r,n)=>{const s=r.dataset.id,a=u.find(c=>c.id===s);a&&(a.order=n)})}function le(e){const o=document.getElementById(e);if(!o)return;o.querySelectorAll(".toggle-switch input").forEach(r=>{r.addEventListener("change",n=>{const s=n.target,a=s.dataset.id,c=u.find(g=>g.id===a);c&&(c.enabled=s.checked)})})}function de(e){const o=document.getElementById(e);o&&(o.querySelectorAll(".item-btn.edit").forEach(t=>{t.addEventListener("click",()=>{const r=t.dataset.id;if(r){B=r;const n=u.find(s=>s.id===r);n&&ee("编辑自定义菜单项",n)}})}),o.querySelectorAll(".item-btn.delete").forEach(t=>{t.addEventListener("click",()=>{const r=t.dataset.id;r&&(u=u.filter(n=>n.id!==r),S("globalMenuList",u),h("菜单项已删除"))})}))}function ie(){const e=document.getElementById("customItemModal"),o=document.getElementById("modalClose"),t=document.getElementById("cancelCustomItem"),r=document.getElementById("saveCustomItem"),n=document.getElementById("customItemAction"),s=document.getElementById("customPromptGroup"),a=document.getElementById("customUrlGroup");ue(),o==null||o.addEventListener("click",A),t==null||t.addEventListener("click",A),e==null||e.addEventListener("click",c=>{c.target===e&&A()}),n==null||n.addEventListener("change",()=>{const c=n.value;s&&(s.style.display=c==="customAI"?"block":"none"),a&&(a.style.display=c==="openUrl"?"block":"none")}),r==null||r.addEventListener("click",()=>{const c=document.getElementById("selectedIcon").value,g=document.getElementById("customItemLabel").value.trim(),p=document.getElementById("customItemAction").value,y=document.getElementById("customPrompt").value.trim(),k=document.getElementById("customUrl").value.trim();if(!c){h("请选择一个图标","error");return}if(!g){h("请输入菜单项名称","error");return}if(p==="customAI"&&!y){h("请输入 AI 提示词","error");return}if(p==="openUrl"&&!k){h("请输入链接地址","error");return}const v=M[c];if(B){const d=u.find(m=>m.id===B);d&&(d.icon=v,d.label=g,d.action=p,p==="customAI"&&(d.customPrompt=y))}else{const d={id:`custom_${Date.now()}`,icon:v,label:g,action:p,enabled:!0,order:u.length,isCustom:!0,customPrompt:p==="customAI"?y:void 0};u.push(d)}S("globalMenuList",u),A(),h(B?"菜单项已更新":"菜单项已添加","success")})}function ue(){const e=document.getElementById("iconPicker");if(!e)return;const o=Object.keys(M);e.innerHTML=o.map(t=>`
    <div class="flex items-center justify-center w-9 h-9 rounded-lg cursor-pointer bg-white/5 border-2 border-transparent text-white/70 transition-all duration-150 hover:bg-white/10 hover:text-white/90 icon-option" data-icon="${t}" title="${t}">
      ${M[t]}
    </div>
  `).join(""),e.querySelectorAll(".icon-option").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".icon-option").forEach(r=>r.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),t.classList.add("border-blue-500","bg-blue-500/20","text-white","selected"),document.getElementById("selectedIcon").value=t.dataset.icon||""})})}function ee(e,o){var k;const t=document.getElementById("customItemModal"),r=document.getElementById("modalTitle"),n=document.getElementById("selectedIcon"),s=document.getElementById("customItemLabel"),a=document.getElementById("customItemAction"),c=document.getElementById("customPrompt"),g=document.getElementById("customUrl"),p=document.getElementById("customPromptGroup"),y=document.getElementById("customUrlGroup");if(r&&(r.textContent=e),o){const v=((k=Object.entries(M).find(([d,m])=>m===o.icon))==null?void 0:k[0])||"";n.value=v,document.querySelectorAll(".icon-option").forEach(d=>{const m=d.dataset.icon===v;d.classList.toggle("selected",m),m?d.classList.add("border-blue-500","bg-blue-500/20","text-white"):d.classList.remove("border-blue-500","bg-blue-500/20","text-white")}),s.value=o.label,a.value=o.action,c.value=o.customPrompt||""}else n.value="",document.querySelectorAll(".icon-option").forEach(v=>v.classList.remove("border-blue-500","bg-blue-500/20","text-white","selected")),s.value="",a.value="customAI",c.value="",g.value="";p&&(p.style.display=a.value==="customAI"?"block":"none"),y&&(y.style.display=a.value==="openUrl"?"block":"none"),t==null||t.classList.add("show")}function A(){const e=document.getElementById("customItemModal");e==null||e.classList.remove("show"),B=null}function j(e){const o=e==="dark"||e==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.classList.toggle("dark",o)}function h(e,o="success"){const t=document.getElementById("toast");if(t){t.textContent=e;const r=o==="success"?"border-green-500/50":"border-red-500/50";t.className=`fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 bg-[#1e1e1e]/95 border text-white/90 shadow-lg transition-all duration-250 backdrop-blur-sm z-[2000] opacity-100 translate-y-0 ${r}`,setTimeout(()=>{t.className="fixed bottom-6 left-1/2 px-5 py-3 text-sm rounded-lg pointer-events-none -translate-x-1/2 translate-y-[100px] bg-[#1e1e1e]/95 border border-white/15 text-white/90 shadow-lg opacity-0 transition-all duration-250 backdrop-blur-sm z-[2000]"},2500)}}
