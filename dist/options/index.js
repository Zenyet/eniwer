import{a as M,b as oe,D as b,c as L,i as P}from"../chunks/types.js";const S="thecircle_data";async function j(){const e=await chrome.storage.local.get(S);return e[S]?e[S]:{config:b,selectionMenuItems:oe,globalMenuItems:M}}async function X(e){const t={...await j(),...e};await chrome.storage.local.set({[S]:t})}async function J(e){const n=await j();n.config={...n.config,...e},await X(n)}async function W(e){await X({globalMenuItems:e})}let d=[],C=null;document.addEventListener("DOMContentLoaded",async()=>{var Q;const e=document.getElementById("apiProvider"),n=document.getElementById("apiKey"),t=document.getElementById("customApiUrl"),s=document.getElementById("customModel"),o=document.getElementById("customApiUrlGroup"),c=document.getElementById("customModelGroup"),l=document.getElementById("apiKeyHelpText"),a=document.getElementById("useStreaming"),m=document.getElementById("preferredLanguage"),g=document.getElementById("popoverPosition"),f=document.getElementById("theme"),B=document.getElementById("saveBtn"),v=document.getElementById("resetBtn"),u=document.getElementById("shortcutDisplay"),I=document.getElementById("recordShortcutBtn"),z=document.getElementById("shortcutHelpText"),w=document.getElementById("screenshotSaveToFile"),U=document.getElementById("screenshotCopyToClipboard"),D=document.getElementById("screenshotEnableAI"),x=document.getElementById("screenshotDefaultAIAction"),$=document.getElementById("screenshotEnableImageGen"),A=document.getElementById("imageGenProvider"),K=document.getElementById("customImageGenUrl"),ee=document.getElementById("customImageGenUrlGroup"),F=document.getElementById("imageSize");let q=!1,k="Alt+Tab";const Y=await j(),E=Y.config,y=E.screenshot||L;d=Y.globalMenuItems,d=ce(d,M),e.value=E.apiProvider,n.value=E.apiKey||"",t.value=E.customApiUrl||"",s.value=E.customModel||"",a.checked=E.useStreaming??!0,m.value=E.preferredLanguage,g.value=E.popoverPosition||"above",f.value=E.theme,k=E.shortcut||"Alt+Tab",N(k),O(E.apiProvider),w.checked=y.saveToFile,U.checked=y.copyToClipboard,D.checked=y.enableAI,x.value=y.defaultAIAction,$.checked=y.enableImageGen,A.value=y.imageGenProvider,K.value=y.customImageGenUrl||"",F.value=y.imageSize,_(y.imageGenProvider),T("globalMenuList",d),re(),(Q=document.getElementById("addGlobalItem"))==null||Q.addEventListener("click",()=>{C=null,Z("添加自定义菜单项")}),e.addEventListener("change",()=>{O(e.value)});function O(i){const r=i==="custom";o.style.display=r?"block":"none",c.style.display=r?"block":"none",i==="groq"?l.textContent="使用 Groq 免费服务无需配置 API Key":r?l.textContent="如果你的 API 需要认证，请填写 API Key":l.textContent=`请填写你的 ${i.toUpperCase()} API Key`}function _(i){const r=i==="custom";ee.style.display=r?"block":"none"}A==null||A.addEventListener("change",()=>{_(A.value)}),I==null||I.addEventListener("click",()=>{q?H():te()});function te(){q=!0,I.textContent="取消录制",I.classList.add("recording"),u.classList.add("recording"),z.textContent="请按下快捷键组合... (ESC 取消)",document.addEventListener("keydown",V)}function H(){q=!1,I.textContent="录制快捷键",I.classList.remove("recording"),u.classList.remove("recording"),z.textContent='点击"录制快捷键"按钮，然后按下你想要的快捷键组合',document.removeEventListener("keydown",V)}function V(i){if(i.preventDefault(),i.stopPropagation(),i.key==="Escape"){H();return}const r=[];(i.ctrlKey||i.metaKey)&&r.push("Ctrl"),i.altKey&&r.push("Alt"),i.shiftKey&&r.push("Shift");const h=i.key;if(!["Control","Alt","Shift","Meta"].includes(h)){const R=h===" "?"Space":h.length===1?h.toUpperCase():h;r.push(R),r.length>=2&&(k=r.join("+"),N(k),H(),p("快捷键已设置，请点击保存按钮"))}}function N(i){if(u){const r=i.split("+");u.innerHTML=r.map((h,R)=>{const ne=R<r.length-1?'<span class="plus">+</span>':"";return`<span class="key">${h}</span>${ne}`}).join("")}}B==null||B.addEventListener("click",async()=>{const i=e.value;if(i==="custom"){if(!t.value){p("请填写自定义 API URL","error");return}if(!s.value){p("请填写模型名称","error");return}try{new URL(t.value)}catch{p("API URL 格式不正确","error");return}}const r={saveToFile:w.checked,copyToClipboard:U.checked,enableAI:D.checked,defaultAIAction:x.value,imageQuality:.92,enableImageGen:$.checked,imageGenProvider:A.value,customImageGenUrl:K.value||void 0,imageSize:F.value},h={apiProvider:i,apiKey:n.value||void 0,customApiUrl:t.value||void 0,customModel:s.value||void 0,useStreaming:a.checked,preferredLanguage:m.value,popoverPosition:g.value,theme:f.value,shortcut:k,screenshot:r};await J(h),await W(d),p("设置已保存","success")}),v==null||v.addEventListener("click",async()=>{await J(b),await W(M),e.value=b.apiProvider,n.value="",t.value="",s.value="",a.checked=b.useStreaming,m.value=b.preferredLanguage,g.value=b.popoverPosition||"above",f.value=b.theme,k=b.shortcut,N(k),O(b.apiProvider),w.checked=L.saveToFile,U.checked=L.copyToClipboard,D.checked=L.enableAI,x.value=L.defaultAIAction,$.checked=L.enableImageGen,A.value=L.imageGenProvider,K.value="",F.value=L.imageSize,_(L.imageGenProvider),d=[...M],T("globalMenuList",d),p("已重置为默认设置","success")})});function ce(e,n){return e.map((t,s)=>{const o=n.find(c=>c.id===t.id);return{...t,enabled:t.enabled??!0,order:t.order??(o==null?void 0:o.order)??s}})}function T(e,n){const t=document.getElementById(e);if(!t)return;const s=[...n].sort((o,c)=>o.order-c.order);t.innerHTML=s.map(o=>{const c=o.isCustom;return`
      <div class="menu-item-config" draggable="true" data-id="${o.id}">
        <span class="drag-handle">⋮⋮</span>
        <span class="item-icon">${o.customIcon||o.icon}</span>
        <span class="item-label">${o.customLabel||o.label}</span>
        <span class="item-action">${o.action}</span>
        <div class="item-actions">
          ${c?`
            <button class="item-btn edit" data-id="${o.id}" title="编辑">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/>
              </svg>
            </button>
            <button class="item-btn delete" data-id="${o.id}" title="删除">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
            </button>
          `:""}
          <label class="toggle-switch small">
            <input type="checkbox" ${o.enabled?"checked":""} data-id="${o.id}">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    `}).join(""),se(e),ae(e),ie(e)}function se(e){const n=document.getElementById(e);if(!n)return;const t=n.querySelectorAll(".menu-item-config");let s=null;t.forEach(o=>{const c=o;c.addEventListener("dragstart",l=>{s=c,c.classList.add("dragging"),l.dataTransfer.effectAllowed="move"}),c.addEventListener("dragend",()=>{c.classList.remove("dragging"),s=null,le(e)}),c.addEventListener("dragover",l=>{l.preventDefault(),l.dataTransfer.dropEffect="move",c.classList.add("drag-over")}),c.addEventListener("dragleave",()=>{c.classList.remove("drag-over")}),c.addEventListener("drop",l=>{if(l.preventDefault(),c.classList.remove("drag-over"),s&&s!==c){const a=c.getBoundingClientRect(),m=a.top+a.height/2;l.clientY<m?n.insertBefore(s,c):n.insertBefore(s,c.nextSibling)}})})}function le(e){const n=document.getElementById(e);if(!n)return;n.querySelectorAll(".menu-item-config").forEach((s,o)=>{const c=s.dataset.id,l=d.find(a=>a.id===c);l&&(l.order=o)})}function ae(e){const n=document.getElementById(e);if(!n)return;n.querySelectorAll(".toggle-switch input").forEach(s=>{s.addEventListener("change",o=>{const c=o.target,l=c.dataset.id,a=d.find(m=>m.id===l);a&&(a.enabled=c.checked)})})}function ie(e){const n=document.getElementById(e);n&&(n.querySelectorAll(".item-btn.edit").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.id;if(s){C=s;const o=d.find(c=>c.id===s);o&&Z("编辑自定义菜单项",o)}})}),n.querySelectorAll(".item-btn.delete").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.id;s&&(d=d.filter(o=>o.id!==s),T("globalMenuList",d),p("菜单项已删除"))})}))}function re(){const e=document.getElementById("customItemModal"),n=document.getElementById("modalClose"),t=document.getElementById("cancelCustomItem"),s=document.getElementById("saveCustomItem"),o=document.getElementById("customItemAction"),c=document.getElementById("customPromptGroup"),l=document.getElementById("customUrlGroup");de(),n==null||n.addEventListener("click",G),t==null||t.addEventListener("click",G),e==null||e.addEventListener("click",a=>{a.target===e&&G()}),o==null||o.addEventListener("change",()=>{const a=o.value;c&&(c.style.display=a==="customAI"?"block":"none"),l&&(l.style.display=a==="openUrl"?"block":"none")}),s==null||s.addEventListener("click",()=>{const a=document.getElementById("selectedIcon").value,m=document.getElementById("customItemLabel").value.trim(),g=document.getElementById("customItemAction").value,f=document.getElementById("customPrompt").value.trim(),B=document.getElementById("customUrl").value.trim();if(!a){p("请选择一个图标","error");return}if(!m){p("请输入菜单项名称","error");return}if(g==="customAI"&&!f){p("请输入 AI 提示词","error");return}if(g==="openUrl"&&!B){p("请输入链接地址","error");return}const v=P[a];if(C){const u=d.find(I=>I.id===C);u&&(u.icon=v,u.label=m,u.action=g,g==="customAI"&&(u.customPrompt=f))}else{const u={id:`custom_${Date.now()}`,icon:v,label:m,action:g,enabled:!0,order:d.length,isCustom:!0,customPrompt:g==="customAI"?f:void 0};d.push(u)}T("globalMenuList",d),G(),p(C?"菜单项已更新":"菜单项已添加","success")})}function de(){const e=document.getElementById("iconPicker");if(!e)return;const n=Object.keys(P);e.innerHTML=n.map(t=>`
    <div class="icon-option" data-icon="${t}" title="${t}">
      ${P[t]}
    </div>
  `).join(""),e.querySelectorAll(".icon-option").forEach(t=>{t.addEventListener("click",()=>{e.querySelectorAll(".icon-option").forEach(s=>s.classList.remove("selected")),t.classList.add("selected"),document.getElementById("selectedIcon").value=t.dataset.icon||""})})}function Z(e,n){var B;const t=document.getElementById("customItemModal"),s=document.getElementById("modalTitle"),o=document.getElementById("selectedIcon"),c=document.getElementById("customItemLabel"),l=document.getElementById("customItemAction"),a=document.getElementById("customPrompt"),m=document.getElementById("customUrl"),g=document.getElementById("customPromptGroup"),f=document.getElementById("customUrlGroup");if(s&&(s.textContent=e),n){const v=((B=Object.entries(P).find(([u,I])=>I===n.icon))==null?void 0:B[0])||"";o.value=v,document.querySelectorAll(".icon-option").forEach(u=>{u.classList.toggle("selected",u.dataset.icon===v)}),c.value=n.label,l.value=n.action,a.value=n.customPrompt||""}else o.value="",document.querySelectorAll(".icon-option").forEach(v=>v.classList.remove("selected")),c.value="",l.value="customAI",a.value="",m.value="";g&&(g.style.display=l.value==="customAI"?"block":"none"),f&&(f.style.display=l.value==="openUrl"?"block":"none"),t==null||t.classList.add("show")}function G(){const e=document.getElementById("customItemModal");e==null||e.classList.remove("show"),C=null}function p(e,n="success"){const t=document.getElementById("toast");t&&(t.textContent=e,t.className=`toast show ${n}`,setTimeout(()=>{t.classList.remove("show")},2500))}
