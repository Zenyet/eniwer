var re=Object.defineProperty;var ae=(u,m,f)=>m in u?re(u,m,{enumerable:!0,configurable:!0,writable:!0,value:f}):u[m]=f;var c=(u,m,f)=>ae(u,typeof m!="symbol"?m+"":m,f);(function(){"use strict";const u={translate:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>',summarize:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>',explain:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',rewrite:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"/></svg>',search:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>',copy:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>',sendToAI:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9l20-7z"/></svg>',codeExplain:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',aiChat:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',summarizePage:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>',switchTab:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>',history:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>',screenshot:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>',bookmark:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',newTab:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',settings:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',download:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',sparkles:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',messageCircle:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',fileText:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>',x:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',columns:'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3h7a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-7m0-18H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h7m0-18v18"/></svg>'};let m=null,f=null,A=!1;function P(){return f||R(),f}function U(){return m||R(),m}function R(){m=document.createElement("div"),m.id="thecircle-shadow-host",m.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
    z-index: 2147483647;
    pointer-events: none;
  `,document.body.appendChild(m),f=m.attachShadow({mode:"open"});const d=document.createElement("div");d.id="thecircle-container",d.className="fixed top-0 left-0 w-screen h-screen pointer-events-none",f.appendChild(d)}function z(d){if(A||!f)return;const e=document.createElement("style");e.textContent=d,f.insertBefore(e,f.firstChild),A=!0}function L(d){const e=P(),t=e.getElementById("thecircle-container")||e;d.style.pointerEvents="auto",t.appendChild(d)}function w(d){d.parentNode&&d.parentNode.removeChild(d)}const b=new Map;function H(){return`${Date.now()}-${Math.random().toString(36).slice(2,9)}`}function x(){for(const[d,e]of b){try{e.port.disconnect()}catch{}b.delete(d)}}async function _(d,e,t,s){return t.useStreaming&&!!s?F("AI_REQUEST",{action:"custom",text:d,systemPrompt:e,config:t},s):await chrome.runtime.sendMessage({type:"AI_REQUEST",payload:{action:"custom",text:d,systemPrompt:e,config:t}})}async function I(d,e,t,s){return t.useStreaming&&!!s?K(d,e,t,s):await chrome.runtime.sendMessage({type:"AI_VISION_REQUEST",payload:{imageDataUrl:d,prompt:e,config:t}})}async function O(d,e,t){return await chrome.runtime.sendMessage({type:"AI_IMAGE_GEN_REQUEST",payload:{prompt:d,config:e,screenshotConfig:t}})}async function F(d,e,t){return new Promise(s=>{const n=H(),i=chrome.runtime.connect({name:"ai-stream"});b.set(n,{port:i,requestId:n});const o=()=>{b.delete(n);try{i.onMessage.removeListener(r)}catch{}},r=a=>{var l;((l=a.payload)==null?void 0:l.requestId)===n&&(a.type==="AI_STREAM_CHUNK"?t(a.payload.chunk||"",a.payload.fullText||""):a.type==="AI_STREAM_END"?(o(),i.disconnect(),s({success:a.payload.success||!1,result:a.payload.result,error:a.payload.error,requestId:n})):a.type==="AI_STREAM_ERROR"&&(o(),i.disconnect(),s({success:!1,error:a.payload.error||"Unknown error",requestId:n})))};i.onDisconnect.addListener(()=>{o(),s({success:!1,error:"请求已取消",requestId:n})}),i.onMessage.addListener(r),i.postMessage({type:d,payload:{...e,requestId:n}})})}async function K(d,e,t,s){return new Promise(n=>{const i=H(),o=chrome.runtime.connect({name:"ai-stream"});b.set(i,{port:o,requestId:i});const r=()=>{b.delete(i);try{o.onMessage.removeListener(a)}catch{}},a=l=>{var h;((h=l.payload)==null?void 0:h.requestId)===i&&(l.type==="AI_STREAM_CHUNK"?s(l.payload.chunk||"",l.payload.fullText||""):l.type==="AI_STREAM_END"?(r(),o.disconnect(),n({success:l.payload.success||!1,result:l.payload.result,error:l.payload.error,requestId:i})):l.type==="AI_STREAM_ERROR"&&(r(),o.disconnect(),n({success:!1,error:l.payload.error||"Unknown error",requestId:i})))};o.onDisconnect.addListener(()=>{r(),n({success:!1,error:"请求已取消",requestId:i})}),o.onMessage.addListener(a),o.postMessage({type:"AI_VISION_REQUEST",payload:{imageDataUrl:d,prompt:e,config:t,requestId:i}})})}function N(d){return`You are a professional translator. Translate the following text to ${d}. Only output the translation, nothing else.`}function Y(){return"You are a summarization expert. Summarize the following text in a concise manner, keeping the key points. Use bullet points if appropriate. Output in the same language as the input."}function X(){return"You are a helpful teacher. Explain the following text in simple terms that anyone can understand. Output in the same language as the input."}function j(){return"You are a professional editor. Rewrite the following text to make it clearer, more engaging, and well-structured. Keep the same meaning. Output in the same language as the input."}function G(){return"You are a senior software engineer. Explain the following code in detail, including what it does, how it works, and any important concepts. Output in the same language as the input text (if any) or in English."}function V(){return"You are a summarization expert. Summarize the following webpage content in a comprehensive but concise manner. Include the main topic, key points, and any important details. Use bullet points for clarity. Output in the same language as the content."}function W(){return`请详细描述这张图片的内容，包括：
1. 主要元素和对象
2. 场景和环境
3. 颜色和视觉特征
4. 任何文字或标识
5. 整体氛围和主题

请用中文回答。`}function Q(d){return`请根据这张图片回答以下问题：

${d}

请用中文回答，尽量详细和准确。`}class Z{constructor(){c(this,"container",null);c(this,"overlay",null);c(this,"menuItems",[]);c(this,"selectedIndex",-1);c(this,"centerX",0);c(this,"centerY",0);c(this,"isVisible",!1);c(this,"onSelect",null);c(this,"resultPanel",null);c(this,"selectionRect",null);c(this,"radius",120);c(this,"isLoading",!1);c(this,"onStopCallback",null);c(this,"onClose",null);c(this,"originalText","");c(this,"currentTranslatedText","");c(this,"isComparisonMode",!1);c(this,"resultType","general");this.handleMouseMove=this.handleMouseMove.bind(this),this.handleKeyUp=this.handleKeyUp.bind(this),this.handleClick=this.handleClick.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}setSelectionInfo(e){this.selectionRect=e}show(e,t,s,n){this.isVisible&&this.hide(),this.menuItems=s.filter(r=>r.enabled!==!1).sort((r,a)=>(r.order??0)-(a.order??0)),this.onSelect=n,this.centerX=e,this.centerY=t,this.selectedIndex=-1,this.isVisible=!0;const i=Math.min(120,(Math.min(window.innerWidth,window.innerHeight)-100)/2),o=this.menuItems.length;o<=4?this.radius=i*.75:o<=6?this.radius=i*.85:this.radius=i,this.createOverlay(),this.createMenu(),this.attachEventListeners()}hide(){if(this.isVisible=!1,this.detachEventListeners(),this.overlay){const e=this.overlay;e.classList.add("thecircle-fade-out");const t=this.container;setTimeout(()=>{w(e),t&&w(t),this.overlay===e&&(this.overlay=null),this.container===t&&(this.container=null)},200)}}showResultOnly(e,t,s){this.centerX=e,this.centerY=t,this.showResult(s,"",!0)}hideResultPanel(){if(this.isLoading&&(x(),this.isLoading=!1),this.resultPanel){this.resultPanel.classList.add("thecircle-fade-out");const e=this.resultPanel;setTimeout(()=>{var t;e&&(w(e),this.resultPanel===e&&(this.resultPanel=null,(t=this.onClose)==null||t.call(this)))},200)}}setOnStop(e){this.onStopCallback=e}setOnClose(e){this.onClose=e}showResult(e,t,s=!1){const n=typeof s=="boolean"?s:s.isLoading||!1;typeof s=="object"?(this.originalText=s.originalText||"",this.resultType=s.type||"general"):(this.originalText="",this.resultType="general"),this.currentTranslatedText=t,this.isComparisonMode=!1,this.resultPanel&&(w(this.resultPanel),this.resultPanel=null),this.isLoading=n,this.resultPanel=document.createElement("div"),this.resultPanel.className="thecircle-result-panel";const i=n?`<div class="thecircle-loading-container">
           <div class="thecircle-loading-row">
             <div class="thecircle-spinner"></div>
             <span class="thecircle-loading-text">正在思考...</span>
           </div>
         </div>`:t;this.resultPanel.innerHTML=`
      <div class="thecircle-result-header">
        <span class="thecircle-result-title">${e}</span>
        <button class="thecircle-result-close">×</button>
      </div>
      <div class="thecircle-result-content-wrapper">
        <div class="thecircle-result-content">
          ${i}
        </div>
      </div>
      <div class="thecircle-result-actions">
        ${n?this.createStopButtonHTML():""}
        ${this.createCopyButtonHTML()}
      </div>
    `,L(this.resultPanel),n||this.renderContent(),this.ensureFooterActions(n,t);const o=this.resultPanel.getBoundingClientRect();let r,a;this.selectionRect?(r=this.selectionRect.left+this.selectionRect.width/2-o.width/2,a=this.selectionRect.bottom+15,a+o.height>window.innerHeight-20&&(a=this.selectionRect.top-o.height-15)):(r=(window.innerWidth-o.width)/2,a=(window.innerHeight-o.height)/2),r<20&&(r=20),r+o.width>window.innerWidth-20&&(r=window.innerWidth-o.width-20),a<20&&(a=20),a+o.height>window.innerHeight-20&&(a=window.innerHeight-o.height-20),this.resultPanel.style.left=`${r}px`,this.resultPanel.style.top=`${a}px`;const l=this.resultPanel.querySelector(".thecircle-result-close");if(l==null||l.addEventListener("click",h=>{h.stopPropagation(),h.preventDefault(),this.hideResultPanel()}),n){const h=this.resultPanel.querySelector('[data-action="stop"]');h==null||h.addEventListener("click",()=>{var p;x(),this.isLoading=!1,(p=this.onStopCallback)==null||p.call(this),h.remove(),this.ensureFooterActions(!1,t)})}this.setupCopyButton(t),this.setupDragBehavior(),this.setupScrollIndicators()}setupDragBehavior(){if(!this.resultPanel)return;const e=this.resultPanel.querySelector(".thecircle-result-header");if(!e)return;let t=!1,s=0,n=0,i=0,o=0;const r=h=>{if(h.target.closest(".thecircle-result-close"))return;h.stopPropagation(),t=!0,s=h.clientX,n=h.clientY;const p=this.resultPanel.getBoundingClientRect();i=p.left,o=p.top,e.style.cursor="grabbing",h.preventDefault(),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)},a=h=>{if(!t||!this.resultPanel)return;const p=h.clientX-s,y=h.clientY-n;let g=i+p,v=o+y;const T=this.resultPanel.getBoundingClientRect(),S=window.innerWidth,M=window.innerHeight;g+T.width<20&&(g=20-T.width),g>S-20&&(g=S-20),v<0&&(v=0),v>M-20&&(v=M-20),this.resultPanel.style.left=`${g}px`,this.resultPanel.style.top=`${v}px`},l=()=>{t=!1,e&&(e.style.cursor="move"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};e.addEventListener("mousedown",r)}createStopButtonHTML(){return`
      <button class="thecircle-stop-btn" data-action="stop">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="6" y="6" width="12" height="12" rx="2"></rect>
        </svg>
        终止
      </button>
    `}createCopyButtonHTML(){return`
      <button class="thecircle-copy-btn">
        <span class="thecircle-copy-btn-icon">${this.getCopyIcon()}</span>
        <span class="thecircle-copy-btn-text">复制</span>
      </button>
    `}getCopyIcon(){return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>`}getCheckIcon(){return`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>`}setupCopyButton(e){if(!this.resultPanel)return;const t=this.resultPanel.querySelector(".thecircle-copy-btn");t&&t.addEventListener("click",()=>{navigator.clipboard.writeText(e),this.showCopyFeedback(t)})}showCopyFeedback(e){const t=e.querySelector(".thecircle-copy-btn-icon"),s=e.querySelector(".thecircle-copy-btn-text");t&&s&&(e.classList.add("copied"),t.innerHTML=this.getCheckIcon(),s.textContent="已复制",setTimeout(()=>{e.classList.remove("copied"),t.innerHTML=this.getCopyIcon(),s.textContent="复制"},1500))}setupScrollIndicators(){if(!this.resultPanel)return;const e=this.resultPanel.querySelector(".thecircle-result-content-wrapper"),t=this.resultPanel.querySelector(".thecircle-result-content");if(e&&t){const s=()=>{const{scrollTop:n,scrollHeight:i,clientHeight:o}=t,r=n>5,a=n<i-o-5;e.classList.toggle("has-scroll-top",r),e.classList.toggle("has-scroll-bottom",a)};t.addEventListener("scroll",s),requestAnimationFrame(s)}}updateResult(e){this.isLoading=!1,this.currentTranslatedText=e,this.resultPanel&&(this.renderContent(),this.ensureFooterActions(!1,e),this.setupScrollIndicators())}streamUpdate(e,t){this.isLoading=!0,this.currentTranslatedText=t,this.resultPanel&&(this.renderContent(),this.ensureFooterActions(!0,t))}renderContent(){if(!this.resultPanel)return;const e=this.resultPanel.querySelector(".thecircle-result-content");if(e)if(e.querySelector(".thecircle-loading-container")&&(e.innerHTML=""),this.isComparisonMode&&this.resultType==="translate"&&this.originalText)e.innerHTML=`
          <div class="thecircle-result-comparison split-view">
             <div class="thecircle-result-comparison-item">
               <div class="thecircle-result-comparison-label">原文</div>
               <div class="thecircle-result-comparison-content">${this.formatStreamContent(this.originalText)}</div>
             </div>
             <div class="thecircle-result-divider"></div>
             <div class="thecircle-result-comparison-item">
               <div class="thecircle-result-comparison-label">译文</div>
               <div class="thecircle-result-comparison-content">${this.formatStreamContent(this.currentTranslatedText)}</div>
             </div>
          </div>
        `,this.resultPanel.classList.add("comparison-mode");else{if(e.querySelector(".thecircle-stream-content")){const t=e.querySelector(".thecircle-stream-content");t&&(t.innerHTML=this.formatStreamContent(this.currentTranslatedText))}else this.isLoading&&!this.currentTranslatedText?e.innerHTML||(e.innerHTML=`
                <div class="thecircle-stream-content"></div>
              `):e.innerHTML=`
                <div class="thecircle-stream-content">${this.formatStreamContent(this.currentTranslatedText)}</div>
              `;this.resultPanel.classList.remove("comparison-mode")}}toggleComparisonMode(){this.isComparisonMode=!this.isComparisonMode,this.renderContent(),this.ensureFooterActions(this.isLoading,this.currentTranslatedText)}createCompareButtonHTML(){return`
      <button class="thecircle-compare-btn" title="显示原文">
        <span class="thecircle-compare-btn-icon">${u.columns}</span>
        <span>对比</span>
      </button>
    `}formatStreamContent(e){return e.replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>")}ensureFooterActions(e,t){if(!this.resultPanel)return;const s=this.resultPanel.querySelector(".thecircle-result-actions");if(!s)return;let n=s.querySelector('[data-action="stop"]');if(e){if(!n){const r=document.createElement("div");r.innerHTML=this.createStopButtonHTML(),n=r.firstElementChild,n&&(s.insertBefore(n,s.firstChild),n.addEventListener("click",()=>{var a;x(),this.isLoading=!1,(a=this.onStopCallback)==null||a.call(this),n==null||n.remove(),this.ensureFooterActions(!1,t)}))}}else n&&n.remove();let i=s.querySelector(".thecircle-compare-btn");if(this.resultType==="translate"&&this.originalText){if(!i){const r=document.createElement("div");if(r.innerHTML=this.createCompareButtonHTML(),i=r.firstElementChild,i){const a=s.querySelector(".thecircle-copy-btn");a?s.insertBefore(i,a):s.appendChild(i),i.addEventListener("click",()=>this.toggleComparisonMode())}}this.isComparisonMode?i==null||i.classList.add("active"):i==null||i.classList.remove("active")}else i&&i.remove();const o=s.querySelector(".thecircle-copy-btn");if(o){const r=o.cloneNode(!0);r.addEventListener("click",()=>{navigator.clipboard.writeText(t),this.showCopyFeedback(r)}),o.replaceWith(r)}else{const r=document.createElement("div");r.innerHTML=this.createCopyButtonHTML();const a=r.firstElementChild;a&&(s.appendChild(a),a.addEventListener("click",()=>{navigator.clipboard.writeText(t),this.showCopyFeedback(a)}))}}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="thecircle-overlay",L(this.overlay)}createMenu(){this.container=document.createElement("div"),this.container.className="thecircle-menu",this.container.style.left=`${this.centerX}px`,this.container.style.top=`${this.centerY}px`;const e=document.createElement("div");e.className="thecircle-center",e.innerHTML=`
      <span class="thecircle-center-label">选择操作</span>
    `,this.container.appendChild(e);const t=this.menuItems.length;this.menuItems.forEach((s,n)=>{const i=n/t*2*Math.PI-Math.PI/2,o=Math.cos(i)*this.radius,r=Math.sin(i)*this.radius,a=document.createElement("div");a.className="thecircle-item",a.dataset.index=String(n),a.style.setProperty("--x",`${o}px`),a.style.setProperty("--y",`${r}px`),a.style.transform=`translate(${o}px, ${r}px)`;const l=s.customIcon||s.icon,h=s.customLabel||s.label;a.innerHTML=`
        <span class="thecircle-item-icon">${l}</span>
        <span class="thecircle-item-label">${h}</span>
      `,this.container.appendChild(a)}),this.overlay.appendChild(this.container),requestAnimationFrame(()=>{var s;(s=this.container)==null||s.classList.add("thecircle-menu-visible")})}attachEventListeners(){document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("keyup",this.handleKeyUp),document.addEventListener("click",this.handleClick),document.addEventListener("keydown",this.handleKeyDown)}detachEventListeners(){document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("keyup",this.handleKeyUp),document.removeEventListener("click",this.handleClick),document.removeEventListener("keydown",this.handleKeyDown)}handleMouseMove(e){if(!this.isVisible||!this.container)return;const t=e.clientX-this.centerX,s=e.clientY-this.centerY;if(Math.sqrt(t*t+s*s)<40){this.setSelectedIndex(-1);return}let i=Math.atan2(s,t);i=i+Math.PI/2,i<0&&(i+=2*Math.PI);const o=this.menuItems.length,r=2*Math.PI/o,a=Math.floor((i+r/2)%(2*Math.PI)/r);this.setSelectedIndex(a)}setSelectedIndex(e){var s,n,i,o,r,a,l;if(this.selectedIndex===e)return;if(this.selectedIndex>=0){const h=(s=this.container)==null?void 0:s.querySelector(`[data-index="${this.selectedIndex}"]`);h==null||h.classList.remove("thecircle-item-selected")}this.selectedIndex=e;const t=(n=this.container)==null?void 0:n.querySelector(".thecircle-center");if(e>=0&&e<this.menuItems.length){const h=(i=this.container)==null?void 0:i.querySelector(`[data-index="${e}"]`);h==null||h.classList.add("thecircle-item-selected"),t==null||t.classList.add("thecircle-center-visible");const p=(o=this.container)==null?void 0:o.querySelector(".thecircle-center-label"),y=(r=this.container)==null?void 0:r.querySelector(".thecircle-center-icon");if(p&&y){const g=this.menuItems[e];p.textContent=g.customLabel||g.label,y.innerHTML=g.customIcon||g.icon}}else{t==null||t.classList.remove("thecircle-center-visible");const h=(a=this.container)==null?void 0:a.querySelector(".thecircle-center-label"),p=(l=this.container)==null?void 0:l.querySelector(".thecircle-center-icon");h&&p&&(h.textContent="选择操作")}}handleKeyUp(e){e.key==="Alt"&&this.selectedIndex>=0&&this.executeSelection()}handleKeyDown(e){if(!this.isVisible)return;const t=this.menuItems.length;switch(e.key){case"Escape":e.preventDefault(),this.hide();break;case"ArrowRight":e.preventDefault(),this.setSelectedIndex(this.selectedIndex<0?0:(this.selectedIndex+1)%t);break;case"ArrowLeft":e.preventDefault(),this.setSelectedIndex(this.selectedIndex<0?t-1:(this.selectedIndex-1+t)%t);break;case"ArrowUp":if(e.preventDefault(),this.selectedIndex<0)this.setSelectedIndex(0);else{const n=(this.selectedIndex+Math.floor(t/2))%t;this.setSelectedIndex(n)}break;case"ArrowDown":if(e.preventDefault(),this.selectedIndex<0)this.setSelectedIndex(Math.floor(t/2));else{const n=(this.selectedIndex+Math.floor(t/2))%t;this.setSelectedIndex(n)}break;case"Tab":e.preventDefault(),e.shiftKey?this.setSelectedIndex(this.selectedIndex<0?t-1:(this.selectedIndex-1+t)%t):this.setSelectedIndex(this.selectedIndex<0?0:(this.selectedIndex+1)%t);break;case"Enter":e.preventDefault(),this.selectedIndex>=0&&this.executeSelection();break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":e.preventDefault();const s=parseInt(e.key)-1;s<t&&(this.setSelectedIndex(s),this.executeSelection());break}}handleClick(e){var i,o;if(!this.isVisible)return;const t=e.composedPath();let s=null,n=!1;for(const r of t)r instanceof HTMLElement&&((i=r.classList)!=null&&i.contains("thecircle-item")&&(s=r),(o=r.classList)!=null&&o.contains("thecircle-menu")&&(n=!0));if(s){const r=parseInt(s.getAttribute("data-index")||"-1");r>=0&&(this.selectedIndex=r,this.executeSelection())}else n||this.hide()}executeSelection(){var e;if(this.selectedIndex>=0&&this.selectedIndex<this.menuItems.length){const t=this.menuItems[this.selectedIndex];this.hide(),(e=this.onSelect)==null||e.call(this,t)}}}const k={saveToFile:!0,copyToClipboard:!1,enableAI:!0,defaultAIAction:"none",imageQuality:.92,enableImageGen:!1,imageGenProvider:"openai",imageSize:"1024x1024"},C={shortcut:"Double+Shift",theme:"light",preferredLanguage:"zh-CN",apiProvider:"groq",useStreaming:!0,screenshot:k,popoverPosition:"above"},D=[{id:"translate",icon:u.translate,label:"翻译",action:"translate",enabled:!0,order:0},{id:"summarize",icon:u.summarize,label:"总结",action:"summarize",enabled:!0,order:1},{id:"explain",icon:u.explain,label:"解释",action:"explain",enabled:!0,order:2},{id:"rewrite",icon:u.rewrite,label:"改写",action:"rewrite",enabled:!0,order:3},{id:"search",icon:u.search,label:"搜索",action:"search",enabled:!0,order:4},{id:"copy",icon:u.copy,label:"复制",action:"copy",enabled:!0,order:5},{id:"sendToAI",icon:u.sendToAI,label:"发送到 AI",action:"sendToAI",enabled:!0,order:6},{id:"codeExplain",icon:u.codeExplain,label:"代码解释",action:"codeExplain",enabled:!0,order:7}],$=[{id:"aiChat",icon:u.aiChat,label:"AI 对话",action:"aiChat",enabled:!0,order:0},{id:"summarizePage",icon:u.summarizePage,label:"总结页面",action:"summarizePage",enabled:!0,order:1},{id:"switchTab",icon:u.switchTab,label:"标签切换",action:"switchTab",enabled:!0,order:2},{id:"history",icon:u.history,label:"历史记录",action:"history",enabled:!0,order:3},{id:"screenshot",icon:u.screenshot,label:"截图",action:"screenshot",enabled:!0,order:4},{id:"bookmark",icon:u.bookmark,label:"书签",action:"bookmark",enabled:!0,order:5},{id:"newTab",icon:u.newTab,label:"新标签",action:"newTab",enabled:!0,order:6},{id:"settings",icon:u.settings,label:"设置",action:"settings",enabled:!0,order:7}],J=`
.thecircle-screenshot-overlay {
  position: fixed;
  inset: 0;
  z-index: 2147483646;
  background: transparent;
  cursor: crosshair;
  animation: thecircle-ss-fade-in 0.15s ease-out;
}
.thecircle-screenshot-overlay.thecircle-screenshot-selecting {
  background: transparent;
}
.thecircle-screenshot-overlay.thecircle-screenshot-idle {
  background: rgba(0, 0, 0, 0.3);
}
.thecircle-screenshot-overlay.thecircle-screenshot-has-selection {
  cursor: default;
}
.thecircle-screenshot-fade-out {
  animation: thecircle-ss-fade-out 0.2s ease-out forwards;
}
@keyframes thecircle-ss-fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes thecircle-ss-fade-out {
  from { opacity: 1; }
  to { opacity: 0; }
}
.thecircle-screenshot-hint {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: rgba(30, 30, 30, 0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 9999px;
  color: rgba(255, 255, 255, 0.95);
  font-size: 14px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  transition: opacity 0.2s ease;
}
.thecircle-screenshot-hint-divider {
  color: rgba(255, 255, 255, 0.3);
}
.thecircle-screenshot-hint-key {
  background: rgba(255, 255, 255, 0.15);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}
.thecircle-screenshot-selection {
  position: fixed;
  border: 2px solid #3b82f6;
  background: transparent;
  box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
  pointer-events: none;
  cursor: move;
}
.thecircle-screenshot-selection.thecircle-screenshot-selection-active {
  pointer-events: auto;
  cursor: move;
}
.thecircle-screenshot-selection.thecircle-screenshot-selection-breathe {
  animation: thecircle-ss-breathe 0.4s ease-out;
}
@keyframes thecircle-ss-breathe {
  0% { border-color: #3b82f6; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
  50% { border-color: #60a5fa; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4), 0 0 20px rgba(59, 130, 246, 0.5); }
  100% { border-color: #3b82f6; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); }
}
.thecircle-screenshot-size {
  position: fixed;
  transform: translateX(-50%);
  padding: 4px 10px;
  background: rgba(30, 30, 30, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 4px;
  color: rgba(255, 255, 255, 0.95);
  font-size: 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  pointer-events: none;
}
.thecircle-screenshot-toolbar {
  position: fixed;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  padding: 8px;
  background: rgba(30, 30, 30, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  animation: thecircle-ss-fade-in 0.15s ease-out;
  z-index: 2147483647;
}
.thecircle-screenshot-toolbar-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 6px;
  color: rgba(255, 255, 255, 0.95);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
}
.thecircle-screenshot-toolbar-btn:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.25);
}
.thecircle-screenshot-toolbar-btn-primary {
  background: #3b82f6;
  border-color: #3b82f6;
  color: #fff;
}
.thecircle-screenshot-toolbar-btn-primary:hover {
  background: #2563eb;
  border-color: #2563eb;
}
`;let B=!1;function ee(){if(B)return;const d=document.createElement("style");d.id="thecircle-screenshot-styles",d.textContent=J,document.head.appendChild(d),B=!0}class te{constructor(){c(this,"overlay",null);c(this,"selectionBox",null);c(this,"sizeIndicator",null);c(this,"hintText",null);c(this,"toolbar",null);c(this,"isSelecting",!1);c(this,"isDragging",!1);c(this,"hasSelection",!1);c(this,"startX",0);c(this,"startY",0);c(this,"dragOffsetX",0);c(this,"dragOffsetY",0);c(this,"currentArea",null);c(this,"callbacks",null);ee(),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}show(e){this.callbacks=e,this.createOverlay(),this.attachEventListeners()}hide(){this.detachEventListeners(),this.overlay&&(this.overlay.classList.add("thecircle-screenshot-fade-out"),setTimeout(()=>{var e;(e=this.overlay)==null||e.remove(),this.overlay=null,this.selectionBox=null,this.sizeIndicator=null,this.hintText=null,this.toolbar=null},200))}hideImmediately(){this.detachEventListeners(),this.overlay&&(this.overlay.remove(),this.overlay=null,this.selectionBox=null,this.sizeIndicator=null,this.hintText=null,this.toolbar=null)}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="thecircle-screenshot-overlay thecircle-screenshot-idle",this.hintText=document.createElement("div"),this.hintText.className="thecircle-screenshot-hint",this.hintText.innerHTML=`
      <span>拖拽选择截图区域</span>
      <span class="thecircle-screenshot-hint-divider">|</span>
      <span class="thecircle-screenshot-hint-key">ESC</span>
      <span>取消</span>
      <span class="thecircle-screenshot-hint-divider">|</span>
      <span>点击截取全屏</span>
    `,this.overlay.appendChild(this.hintText),this.selectionBox=document.createElement("div"),this.selectionBox.className="thecircle-screenshot-selection",this.selectionBox.style.display="none",this.overlay.appendChild(this.selectionBox),this.sizeIndicator=document.createElement("div"),this.sizeIndicator.className="thecircle-screenshot-size",this.sizeIndicator.style.display="none",this.overlay.appendChild(this.sizeIndicator),document.body.appendChild(this.overlay)}createToolbar(){var s;if(!this.overlay||!this.currentArea)return;(s=this.toolbar)==null||s.remove(),this.toolbar=document.createElement("div"),this.toolbar.className="thecircle-screenshot-toolbar";const e=this.currentArea.y+this.currentArea.height+10,t=this.currentArea.x+this.currentArea.width/2;this.toolbar.style.left=`${t}px`,this.toolbar.style.top=`${e}px`,e+50>window.innerHeight&&(this.toolbar.style.top=`${this.currentArea.y-50}px`),this.toolbar.innerHTML=`
      <button class="thecircle-screenshot-toolbar-btn thecircle-screenshot-toolbar-btn-primary" data-action="confirm">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        确认
      </button>
      <button class="thecircle-screenshot-toolbar-btn" data-action="reselect">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 4v6h6"></path>
          <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
        </svg>
        重选
      </button>
      <button class="thecircle-screenshot-toolbar-btn" data-action="cancel">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        取消
      </button>
    `,this.toolbar.addEventListener("click",n=>{var a;const o=n.target.closest("button");if(!o)return;const r=o.dataset.action;r==="confirm"?this.confirmSelection():r==="reselect"?this.resetSelection():r==="cancel"&&(this.hide(),(a=this.callbacks)==null||a.onCancel())}),this.overlay.appendChild(this.toolbar)}confirmSelection(){const e=this.currentArea;this.hideImmediately(),requestAnimationFrame(()=>{var t;(t=this.callbacks)==null||t.onSelect(e)})}resetSelection(){var e;this.hasSelection=!1,this.currentArea=null,this.isDragging=!1,(e=this.toolbar)==null||e.remove(),this.toolbar=null,this.overlay&&(this.overlay.classList.add("thecircle-screenshot-idle"),this.overlay.classList.remove("thecircle-screenshot-has-selection")),this.selectionBox&&(this.selectionBox.style.display="none",this.selectionBox.classList.remove("thecircle-screenshot-selection-active"),this.selectionBox.classList.remove("thecircle-screenshot-selection-breathe")),this.sizeIndicator&&(this.sizeIndicator.style.display="none"),this.hintText&&(this.hintText.style.opacity="1")}attachEventListeners(){document.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),document.addEventListener("keydown",this.handleKeyDown)}detachEventListeners(){document.removeEventListener("mousedown",this.handleMouseDown),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.removeEventListener("keydown",this.handleKeyDown)}handleMouseDown(e){if(!this.overlay||e.button!==0||this.toolbar&&this.toolbar.contains(e.target))return;const t=e.clientX,s=e.clientY;if(this.hasSelection&&this.currentArea){const{x:n,y:i,width:o,height:r}=this.currentArea;if(t>=n&&t<=n+o&&s>=i&&s<=i+r){this.isDragging=!0,this.dragOffsetX=t-n,this.dragOffsetY=s-i,e.preventDefault();return}else{this.triggerBreatheAnimation(),e.preventDefault();return}}this.isSelecting=!0,this.startX=t,this.startY=s,this.overlay.classList.remove("thecircle-screenshot-idle"),this.selectionBox&&(this.selectionBox.style.display="block",this.selectionBox.style.left=`${this.startX}px`,this.selectionBox.style.top=`${this.startY}px`,this.selectionBox.style.width="0px",this.selectionBox.style.height="0px"),this.sizeIndicator&&(this.sizeIndicator.style.display="block"),this.hintText&&(this.hintText.style.opacity="0"),e.preventDefault()}handleMouseMove(e){if(this.isDragging&&this.currentArea&&this.selectionBox){const a=Math.max(0,Math.min(window.innerWidth-this.currentArea.width,e.clientX-this.dragOffsetX)),l=Math.max(0,Math.min(window.innerHeight-this.currentArea.height,e.clientY-this.dragOffsetY));this.currentArea.x=a,this.currentArea.y=l,this.selectionBox.style.left=`${a}px`,this.selectionBox.style.top=`${l}px`,this.updateToolbarPosition(),this.sizeIndicator&&(this.sizeIndicator.style.left=`${a+this.currentArea.width/2}px`,this.sizeIndicator.style.top=`${l+this.currentArea.height+10}px`);return}if(!this.isSelecting||!this.selectionBox||!this.sizeIndicator)return;const t=e.clientX,s=e.clientY,n=Math.min(this.startX,t),i=Math.min(this.startY,s),o=Math.abs(t-this.startX),r=Math.abs(s-this.startY);this.selectionBox.style.left=`${n}px`,this.selectionBox.style.top=`${i}px`,this.selectionBox.style.width=`${o}px`,this.selectionBox.style.height=`${r}px`,this.sizeIndicator.textContent=`${o} × ${r}`,this.sizeIndicator.style.left=`${n+o/2}px`,this.sizeIndicator.style.top=`${i+r+10}px`}handleMouseUp(e){var a,l;if(this.isDragging){this.isDragging=!1;return}if(!this.isSelecting){this.hasSelection||(this.hideImmediately(),requestAnimationFrame(()=>{var h;(h=this.callbacks)==null||h.onSelect(null)}));return}this.isSelecting=!1;const t=e.clientX,s=e.clientY,n=Math.min(this.startX,t),i=Math.min(this.startY,s),o=Math.abs(t-this.startX),r=Math.abs(s-this.startY);if(o<10||r<10){this.hideImmediately(),requestAnimationFrame(()=>{var h;(h=this.callbacks)==null||h.onSelect(null)});return}this.currentArea={x:n,y:i,width:o,height:r},this.hasSelection=!0,(a=this.overlay)==null||a.classList.add("thecircle-screenshot-has-selection"),(l=this.selectionBox)==null||l.classList.add("thecircle-screenshot-selection-active"),this.createToolbar()}triggerBreatheAnimation(){this.selectionBox&&(this.selectionBox.classList.remove("thecircle-screenshot-selection-breathe"),this.selectionBox.offsetWidth,this.selectionBox.classList.add("thecircle-screenshot-selection-breathe"),setTimeout(()=>{var e;(e=this.selectionBox)==null||e.classList.remove("thecircle-screenshot-selection-breathe")},400))}updateToolbarPosition(){if(!this.toolbar||!this.currentArea)return;const e=this.currentArea.y+this.currentArea.height+10,t=this.currentArea.x+this.currentArea.width/2;this.toolbar.style.left=`${t}px`,e+50>window.innerHeight?this.toolbar.style.top=`${this.currentArea.y-50}px`:this.toolbar.style.top=`${e}px`}handleKeyDown(e){var t;e.key==="Escape"?(e.preventDefault(),this.hide(),(t=this.callbacks)==null||t.onCancel()):e.key==="Enter"&&this.hasSelection&&(e.preventDefault(),this.confirmSelection())}}class se{constructor(){c(this,"panel",null);c(this,"imageDataUrl","");c(this,"callbacks",null);c(this,"config",k);c(this,"isShowingInput",!1);c(this,"inputMode","ask");c(this,"isLoading",!1)}show(e,t,s){this.imageDataUrl=e,this.callbacks=t,this.config=s||k,this.createPanel()}hide(){this.isLoading&&(x(),this.isLoading=!1),this.panel&&(this.panel.classList.add("thecircle-screenshot-panel-exit"),setTimeout(()=>{this.panel&&(w(this.panel),this.panel=null)},200))}showLoading(e){if(!this.panel)return;this.isLoading=!0;const t=this.panel.querySelector(".thecircle-screenshot-actions");if(t){t.innerHTML=`
        <div class="thecircle-screenshot-loading">
          <div class="thecircle-spinner"></div>
          <span>${e}</span>
        </div>
        <div style="display: flex; justify-content: center; margin-top: 12px;">
          <button class="thecircle-stop-btn" data-action="stop">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="6" width="12" height="12" rx="2"></rect>
            </svg>
            终止
          </button>
        </div>
      `;const s=t.querySelector('[data-action="stop"]');s==null||s.addEventListener("click",()=>{x(),this.isLoading=!1,this.resetActions()})}}showResult(e,t){if(!this.panel)return;this.isLoading=!1;const s=this.panel.querySelector(".thecircle-screenshot-actions");if(s){s.innerHTML=`
        <div class="thecircle-screenshot-result">
          <div class="thecircle-screenshot-result-header">${e}</div>
          <div class="thecircle-screenshot-result-content">${t}</div>
          <div class="thecircle-screenshot-result-actions">
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="copy-result">
              ${u.copy}
              <span>复制</span>
            </button>
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="back">
              <span>返回</span>
            </button>
          </div>
        </div>
      `;const n=s.querySelector('[data-action="copy-result"]');n==null||n.addEventListener("click",()=>{navigator.clipboard.writeText(t);const o=n.querySelector("span");if(o){const r=o.textContent;o.textContent="已复制",setTimeout(()=>{o.textContent=r},1500)}});const i=s.querySelector('[data-action="back"]');i==null||i.addEventListener("click",()=>{this.resetActions()})}}showGeneratedImage(e){if(!this.panel)return;this.isLoading=!1;const t=this.panel.querySelector(".thecircle-screenshot-actions");if(t){t.innerHTML=`
        <div class="thecircle-screenshot-generated">
          <img src="${e}" alt="Generated image" class="thecircle-screenshot-generated-img" />
          <div class="thecircle-screenshot-result-actions">
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-primary" data-action="save-generated">
              ${u.download}
              <span>保存</span>
            </button>
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="back">
              <span>返回</span>
            </button>
          </div>
        </div>
      `;const s=t.querySelector('[data-action="save-generated"]');s==null||s.addEventListener("click",async()=>{const i=document.createElement("a");i.href=e,i.download=`generated-${Date.now()}.png`,i.click()});const n=t.querySelector('[data-action="back"]');n==null||n.addEventListener("click",()=>{this.resetActions()})}}streamUpdate(e,t){if(!this.panel)return;this.isLoading=!0;const s=this.panel.querySelector(".thecircle-screenshot-actions");if(!s)return;if(s.querySelector(".thecircle-screenshot-loading")){s.innerHTML=`
        <div class="thecircle-screenshot-result">
          <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
            <button class="thecircle-stop-btn" data-action="stop">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
              </svg>
              终止
            </button>
          </div>
          <div class="thecircle-screenshot-result-content"></div>
          <div class="thecircle-screenshot-result-actions">
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="copy-result">
              ${u.copy}
              <span>复制</span>
            </button>
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="back">
              <span>返回</span>
            </button>
          </div>
        </div>
      `;const o=s.querySelector('[data-action="stop"]');o==null||o.addEventListener("click",()=>{var l;x(),this.isLoading=!1,(l=o.parentElement)==null||l.remove()});const r=s.querySelector('[data-action="copy-result"]');r==null||r.addEventListener("click",()=>{const l=s.querySelector(".thecircle-screenshot-result-content");if(l){navigator.clipboard.writeText(l.textContent||"");const h=r.querySelector("span");if(h){const p=h.textContent;h.textContent="已复制",setTimeout(()=>{h.textContent=p},1500)}}});const a=s.querySelector('[data-action="back"]');a==null||a.addEventListener("click",()=>{this.resetActions()})}const i=s.querySelector(".thecircle-screenshot-result-content");i&&(i.innerHTML=this.formatContent(t),i.scrollTop=i.scrollHeight)}formatContent(e){return e.replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>")}resetActions(){if(!this.panel)return;this.isLoading=!1;const e=this.panel.querySelector(".thecircle-screenshot-actions");e&&(e.innerHTML=this.createActionsHTML(),this.setupActionListeners())}createPanel(){this.panel=document.createElement("div"),this.panel.className="thecircle-screenshot-panel",this.panel.innerHTML=`
      <div class="thecircle-screenshot-header">
        <span class="thecircle-screenshot-title">截图预览</span>
        <button class="thecircle-screenshot-close">${u.x}</button>
      </div>
      <div class="thecircle-screenshot-preview">
        <img src="${this.imageDataUrl}" alt="Screenshot preview" />
      </div>
      <div class="thecircle-screenshot-actions">
        ${this.createActionsHTML()}
      </div>
    `,L(this.panel),this.positionPanel(),this.setupDragBehavior();const e=this.panel.querySelector(".thecircle-screenshot-close");e==null||e.addEventListener("click",()=>{var s;this.hide(),(s=this.callbacks)==null||s.onClose()}),this.setupActionListeners();const t=s=>{var n;s.key==="Escape"&&(this.hide(),(n=this.callbacks)==null||n.onClose(),document.removeEventListener("keydown",t))};document.addEventListener("keydown",t)}setupDragBehavior(){if(!this.panel)return;const e=this.panel.querySelector(".thecircle-screenshot-header");if(!e)return;let t=!1,s=0,n=0,i=0,o=0;e.style.cursor="move",e.style.userSelect="none";const r=h=>{if(h.target.closest(".thecircle-screenshot-close"))return;h.stopPropagation(),t=!0,s=h.clientX,n=h.clientY;const p=this.panel.getBoundingClientRect();i=p.left,o=p.top,e.style.cursor="grabbing",h.preventDefault(),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)},a=h=>{if(!t||!this.panel)return;const p=h.clientX-s,y=h.clientY-n;let g=i+p,v=o+y;const T=this.panel.getBoundingClientRect(),S=window.innerWidth,M=window.innerHeight;g+T.width<20&&(g=20-T.width),g>S-20&&(g=S-20),v<0&&(v=0),v>M-20&&(v=M-20),this.panel.style.left=`${g}px`,this.panel.style.top=`${v}px`},l=()=>{t=!1,e&&(e.style.cursor="move"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};e.addEventListener("mousedown",r)}createActionsHTML(){const e=[{action:"save",icon:u.download,label:"保存",primary:!0},{action:"copy",icon:u.copy,label:"复制"}];return this.config.enableAI&&e.push({action:"ask",icon:u.messageCircle,label:"问AI"},{action:"describe",icon:u.fileText,label:"描述图片"}),this.config.enableImageGen&&e.push({action:"generate",icon:u.sparkles,label:"AI生图"}),`
      <div class="thecircle-screenshot-btn-group">
        ${e.map(t=>`
          <button class="thecircle-screenshot-btn ${t.primary?"thecircle-screenshot-btn-primary":"thecircle-screenshot-btn-secondary"}" data-action="${t.action}">
            ${t.icon}
            <span>${t.label}</span>
          </button>
        `).join("")}
      </div>
    `}setupActionListeners(){if(!this.panel)return;const e=this.panel.querySelector('[data-action="save"]');e==null||e.addEventListener("click",()=>{var o;return(o=this.callbacks)==null?void 0:o.onSave()});const t=this.panel.querySelector('[data-action="copy"]');t==null||t.addEventListener("click",()=>{var r;(r=this.callbacks)==null||r.onCopy();const o=t.querySelector("span");if(o){const a=o.textContent;o.textContent="已复制",setTimeout(()=>{o.textContent=a},1500)}});const s=this.panel.querySelector('[data-action="ask"]');s==null||s.addEventListener("click",()=>this.showInputField("ask"));const n=this.panel.querySelector('[data-action="describe"]');n==null||n.addEventListener("click",()=>{var o;return(o=this.callbacks)==null?void 0:o.onDescribe()});const i=this.panel.querySelector('[data-action="generate"]');i==null||i.addEventListener("click",()=>this.showInputField("generate"))}showInputField(e){if(!this.panel)return;this.inputMode=e,this.isShowingInput=!0;const t=this.panel.querySelector(".thecircle-screenshot-actions");if(t){const s=e==="ask"?"输入你想问的问题...":"输入生成提示词...",n=e==="ask"?"发送":"生成";t.innerHTML=`
        <div class="thecircle-screenshot-input-area">
          <input
            type="text"
            class="thecircle-screenshot-input"
            placeholder="${s}"
            autofocus
          />
          <div class="thecircle-screenshot-input-actions">
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-secondary" data-action="cancel-input">
              取消
            </button>
            <button class="thecircle-screenshot-btn thecircle-screenshot-btn-primary" data-action="submit-input">
              ${n}
            </button>
          </div>
        </div>
      `;const i=t.querySelector(".thecircle-screenshot-input");i==null||i.focus(),i==null||i.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),this.submitInput(i.value))});const o=t.querySelector('[data-action="cancel-input"]');o==null||o.addEventListener("click",()=>this.resetActions());const r=t.querySelector('[data-action="submit-input"]');r==null||r.addEventListener("click",()=>this.submitInput(i.value))}}submitInput(e){var s,n;const t=e.trim();t&&(this.inputMode==="ask"?(s=this.callbacks)==null||s.onAskAI(t):(n=this.callbacks)==null||n.onGenerateImage(t))}positionPanel(){if(!this.panel)return;const e=this.panel.getBoundingClientRect(),t=(window.innerWidth-e.width)/2,s=(window.innerHeight-e.height)/2;this.panel.style.left=`${Math.max(20,t)}px`,this.panel.style.top=`${Math.max(20,s)}px`}}class ne{constructor(e){c(this,"selectedText","");c(this,"config");c(this,"screenshotSelector",null);c(this,"screenshotPanel",null);c(this,"currentScreenshotDataUrl","");c(this,"flowCallbacks",null);this.config=e}setSelectedText(e){this.selectedText=e}setConfig(e){this.config=e}setFlowCallbacks(e){this.flowCallbacks=e}async execute(e,t){switch(e.action){case"translate":return this.handleTranslate(t);case"summarize":return this.handleSummarize(t);case"explain":return this.handleExplain(t);case"rewrite":return this.handleRewrite(t);case"codeExplain":return this.handleCodeExplain(t);case"search":return this.handleSearch();case"copy":return this.handleCopy();case"sendToAI":return this.handleSendToAI();case"aiChat":return this.handleAIChat();case"summarizePage":return this.handleSummarizePage(t);case"switchTab":return this.handleSwitchTab();case"history":return this.handleHistory();case"screenshot":return this.handleScreenshotFlow();case"bookmark":return this.handleBookmark();case"newTab":return this.handleNewTab();case"settings":return this.handleSettings();default:return{type:"error",result:"Unknown action"}}}async handleTranslate(e){return this.selectedText?this.callAIAction("translate",this.selectedText,e):{type:"error",result:"请先选择要翻译的文字"}}async handleSummarize(e){return this.selectedText?this.callAIAction("summarize",this.selectedText,e):{type:"error",result:"请先选择要总结的文字"}}async handleExplain(e){return this.selectedText?this.callAIAction("explain",this.selectedText,e):{type:"error",result:"请先选择要解释的文字"}}async handleRewrite(e){return this.selectedText?this.callAIAction("rewrite",this.selectedText,e):{type:"error",result:"请先选择要改写的文字"}}async handleCodeExplain(e){return this.selectedText?this.callAIAction("codeExplain",this.selectedText,e):{type:"error",result:"请先选择要解释的代码"}}async handleSummarizePage(e){return this.callAIAction("summarizePage",document.body.innerText.slice(0,1e4),e)}async callAIAction(e,t,s){const n=this.validateAIConfig();if(n)return{type:"error",result:n};let i;switch(e){case"translate":i=N(this.config.preferredLanguage||"zh-CN");break;case"summarize":i=Y();break;case"explain":i=X();break;case"rewrite":i=j();break;case"codeExplain":i=G();break;case"summarizePage":i=V();break;default:return{type:"error",result:"Unknown AI action"}}try{const o=await _(t,i,this.config,s);return o.success?{type:"ai",result:o.result}:{type:"error",result:o.error||"AI 请求失败"}}catch(o){return{type:"error",result:`请求失败: ${o}`}}}validateAIConfig(){const{apiProvider:e,apiKey:t,customApiUrl:s,customModel:n}=this.config;if(e==="custom"){if(!s)return"请在设置中配置自定义 API 地址";if(!n)return"请在设置中配置自定义模型名称"}else if(!t)return`请在设置中配置 ${{openai:"OpenAI",anthropic:"Anthropic",gemini:"Google Gemini",groq:"Groq"}[e]||e} API Key`;return null}handleSearch(){const t=`https://www.google.com/search?q=${encodeURIComponent(this.selectedText||"")}`;return window.open(t,"_blank"),{type:"redirect",url:t}}handleCopy(){return this.selectedText?(navigator.clipboard.writeText(this.selectedText),{type:"success",result:"已复制到剪贴板"}):{type:"error",result:"没有选中的文字"}}handleSendToAI(){const t=`https://chat.openai.com/?q=${encodeURIComponent(this.selectedText||"")}`;return window.open(t,"_blank"),{type:"redirect",url:t}}handleAIChat(){return window.open("https://chat.openai.com/","_blank"),{type:"redirect",url:"https://chat.openai.com/"}}async handleSwitchTab(){try{const e=await chrome.runtime.sendMessage({type:"GET_TABS"});return e!=null&&e.tabs?{type:"info",result:`打开了 ${e.tabs.length} 个标签页`}:{type:"error",result:"获取标签页失败"}}catch{return{type:"error",result:"获取标签页失败"}}}handleHistory(){return chrome.runtime.sendMessage({type:"OPEN_URL",payload:"chrome://history"}),{type:"redirect",url:"chrome://history"}}handleScreenshotFlow(){return this.screenshotSelector=new te,this.screenshotSelector.show({onSelect:async e=>{await this.captureAndShowPanel(e)},onCancel:()=>{var e;(e=this.flowCallbacks)==null||e.onToast("截图已取消","info")}}),{type:"silent",result:""}}async captureAndShowPanel(e){var t,s;try{const n=await chrome.runtime.sendMessage({type:"CAPTURE_VISIBLE_TAB"});if(!(n!=null&&n.success)||!n.dataUrl){(t=this.flowCallbacks)==null||t.onToast("截图失败","error");return}let i=n.dataUrl;e&&(i=await this.cropImage(n.dataUrl,e)),this.currentScreenshotDataUrl=i;const o=this.config.screenshot||k;this.screenshotPanel=new se,this.screenshotPanel.show(i,{onSave:()=>this.saveScreenshot(),onCopy:()=>this.copyScreenshotToClipboard(),onAskAI:r=>this.askAIAboutImage(r),onDescribe:()=>this.describeImage(),onGenerateImage:r=>this.generateImageFromPrompt(r),onClose:()=>{this.screenshotPanel=null}},o)}catch(n){(s=this.flowCallbacks)==null||s.onToast(`截图失败: ${n}`,"error")}}async cropImage(e,t){return new Promise((s,n)=>{const i=new Image;i.onload=()=>{const o=document.createElement("canvas"),r=o.getContext("2d");if(!r){n(new Error("Failed to get canvas context"));return}const a=window.devicePixelRatio||1;o.width=t.width*a,o.height=t.height*a,r.drawImage(i,t.x*a,t.y*a,t.width*a,t.height*a,0,0,t.width*a,t.height*a);const l=this.config.screenshot||k;s(o.toDataURL("image/png",l.imageQuality))},i.onerror=()=>n(new Error("Failed to load image")),i.src=e})}async saveScreenshot(){var e,t;try{const s=`screenshot-${Date.now()}.png`;await chrome.runtime.sendMessage({type:"DOWNLOAD_IMAGE",payload:{dataUrl:this.currentScreenshotDataUrl,filename:s}}),(e=this.flowCallbacks)==null||e.onToast("截图已保存","success")}catch(s){(t=this.flowCallbacks)==null||t.onToast(`保存失败: ${s}`,"error")}}async copyScreenshotToClipboard(){var e,t;try{const n=await(await fetch(this.currentScreenshotDataUrl)).blob();await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]),(e=this.flowCallbacks)==null||e.onToast("已复制到剪贴板","success")}catch(s){(t=this.flowCallbacks)==null||t.onToast(`复制失败: ${s}`,"error")}}async askAIAboutImage(e){if(!this.screenshotPanel)return;const t=this.validateAIConfig();if(t){this.screenshotPanel.showResult("错误",t);return}this.screenshotPanel.showLoading("AI 正在分析...");const s=Q(e),n=await I(this.currentScreenshotDataUrl,s,this.config,(i,o)=>{var r;(r=this.screenshotPanel)==null||r.streamUpdate(i,o)});n.success&&n.result?this.screenshotPanel.showResult("AI 回答",n.result):this.screenshotPanel.showResult("错误",n.error||"AI 请求失败")}async describeImage(){if(!this.screenshotPanel)return;const e=this.validateAIConfig();if(e){this.screenshotPanel.showResult("错误",e);return}this.screenshotPanel.showLoading("AI 正在描述图片...");const t=W(),s=await I(this.currentScreenshotDataUrl,t,this.config,(n,i)=>{var o;(o=this.screenshotPanel)==null||o.streamUpdate(n,i)});s.success&&s.result?this.screenshotPanel.showResult("图片描述",s.result):this.screenshotPanel.showResult("错误",s.error||"AI 请求失败")}async generateImageFromPrompt(e){if(!this.screenshotPanel)return;const t=this.config.screenshot||k;if(!t.enableImageGen){this.screenshotPanel.showResult("错误","请先在设置中启用 AI 生图功能");return}if(t.imageGenProvider==="openai"){if(!this.config.apiKey){this.screenshotPanel.showResult("错误","使用 OpenAI 生图需要配置 API Key");return}}else if(t.imageGenProvider==="custom"&&!t.customImageGenUrl){this.screenshotPanel.showResult("错误","请配置自定义生图 API 地址");return}this.screenshotPanel.showLoading("正在生成图片...");const s=await I(this.currentScreenshotDataUrl,"用简洁的英文描述这张图片的主要内容和风格特征，不超过100词。",this.config),n=s.success?s.result:"",i=n?`Based on this context: "${n}". User request: ${e}`:e,o=await O(i,this.config,t);o.success&&o.imageUrl?this.screenshotPanel.showGeneratedImage(o.imageUrl):this.screenshotPanel.showResult("错误",o.error||"图像生成失败")}async handleBookmark(){try{return await chrome.runtime.sendMessage({type:"ADD_BOOKMARK",payload:{title:document.title,url:window.location.href}}),{type:"success",result:"已添加书签"}}catch{return{type:"error",result:"添加书签失败"}}}handleNewTab(){return chrome.runtime.sendMessage({type:"NEW_TAB"}),{type:"success",result:"已打开新标签页"}}handleSettings(){return chrome.runtime.openOptionsPage(),{type:"redirect",result:"已打开设置页面"}}}class ie{constructor(){c(this,"popover",null);c(this,"callbacks",null);c(this,"hideTimeout",null);c(this,"currentRange",null);c(this,"preferredPosition","above");c(this,"scrollHandler",null);c(this,"rafId",null)}show(e,t,s="above"){this.hide(),this.callbacks=t,this.preferredPosition=s;const n=window.getSelection();n&&n.rangeCount>0&&(this.currentRange=n.getRangeAt(0).cloneRange()),this.createPopover(e,s),this.setupScrollListener(),requestAnimationFrame(()=>{this.popover&&(this.popover.style.opacity="1")})}hide(){if(this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null),this.removeScrollListener(),this.popover){this.popover.classList.add("thecircle-selection-popover-exit");const e=this.popover;setTimeout(()=>{w(e)},150),this.popover=null}this.currentRange=null}isVisible(){return this.popover!==null}setupScrollListener(){this.scrollHandler=()=>{this.rafId===null&&(this.rafId=requestAnimationFrame(()=>{this.updatePosition(),this.rafId=null}))},window.addEventListener("scroll",this.scrollHandler,!0)}removeScrollListener(){this.scrollHandler&&(window.removeEventListener("scroll",this.scrollHandler,!0),this.scrollHandler=null),this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null)}updatePosition(){if(!this.popover||!this.currentRange)return;const e=this.currentRange.getBoundingClientRect();if(e.bottom<0||e.top>window.innerHeight){this.popover.style.opacity="0",this.popover.style.pointerEvents="none";return}else this.popover.style.opacity="1",this.popover.style.pointerEvents="auto";const{left:t,top:s}=this.calculatePosition(e,this.preferredPosition);this.popover.style.left=`${t}px`,this.popover.style.top=`${s}px`}calculatePosition(e,t){let o=e.left+e.width/2-16,r;return t==="above"?(r=e.top-32-8,r<10&&(r=e.bottom+8)):(r=e.bottom+8,r+32>window.innerHeight-10&&(r=e.top-32-8)),o<10&&(o=10),o+32>window.innerWidth-10&&(o=window.innerWidth-32-10),{left:o,top:r}}createPopover(e,t){this.popover=document.createElement("div"),this.popover.className="thecircle-selection-popover";const{left:s,top:n}=this.calculatePosition(e,t);this.popover.style.left=`${s}px`,this.popover.style.top=`${n}px`,this.popover.innerHTML=`
      <div class="thecircle-selection-popover-container">
        <button class="thecircle-selection-popover-btn" data-action="translate" title="翻译">
          ${u.translate}
        </button>
      </div>
    `,L(this.popover);const i=this.popover.querySelector('[data-action="translate"]');i==null||i.addEventListener("click",o=>{var r;o.stopPropagation(),(r=this.callbacks)==null||r.onTranslate(),this.hide()}),this.popover.addEventListener("mousedown",o=>{o.stopPropagation()})}}const E="thecircle_data";async function oe(){const d=await chrome.storage.local.get(E);return d[E]?d[E]:{config:C,selectionMenuItems:D,globalMenuItems:$}}class q{constructor(){c(this,"radialMenu");c(this,"menuActions");c(this,"selectionPopover");c(this,"selectionMenuItems",D);c(this,"globalMenuItems",$);c(this,"config",C);c(this,"lastKeyTime",0);c(this,"lastKey","");c(this,"DOUBLE_TAP_DELAY",300);c(this,"activeToasts",[]);c(this,"MAX_TOASTS",4);c(this,"currentSelectedText","");this.radialMenu=new Z,this.menuActions=new ne(C),this.selectionPopover=new ie,this.menuActions.setFlowCallbacks({onToast:(e,t)=>this.showToast(e,t)}),this.radialMenu.setOnClose(()=>{this.selectionPopover.hide()}),this.init()}async init(){P();try{const e=chrome.runtime.getURL("assets/content.css"),s=await(await fetch(e)).text();z(s)}catch(e){console.error("The Circle: Failed to load styles",e)}await this.loadConfig(),this.setupKeyboardShortcut(),this.setupMessageListener(),this.setupStorageListener(),this.setupSelectionListener(),console.log("The Circle: Initialized with Shadow DOM")}async loadConfig(){try{const e=await oe();this.config=e.config,this.menuActions.setConfig(e.config),this.selectionMenuItems=e.selectionMenuItems,this.globalMenuItems=e.globalMenuItems,this.applyTheme(this.config.theme)}catch(e){console.error("The Circle: Failed to load config",e)}}setupStorageListener(){chrome.storage.onChanged.addListener(e=>{e.thecircle_config&&(this.config={...this.config,...e.thecircle_config.newValue},this.menuActions.setConfig(this.config),this.applyTheme(this.config.theme))})}applyTheme(e){var i;const t=U(),s=(i=t.shadowRoot)==null?void 0:i.getElementById("thecircle-container");console.log("The Circle: Applying theme:",e);const n=["dark","light"];if(t.classList.remove(...n),s==null||s.classList.remove(...n),e==="dark")t.classList.add("dark"),s==null||s.classList.add("dark");else if(e==="light")t.classList.add("light"),s==null||s.classList.add("light");else if(e==="system"){const o=window.matchMedia("(prefers-color-scheme: dark)"),r=a=>{t.classList.remove(...n),s==null||s.classList.remove(...n),a.matches?(t.classList.add("dark"),s==null||s.classList.add("dark")):(t.classList.add("light"),s==null||s.classList.add("light"))};r(o),o.onchange=r}}setupSelectionListener(){let e=null;document.addEventListener("mouseup",t=>{var n,i,o,r;const s=t.composedPath();for(const a of s)if(a instanceof HTMLElement&&((n=a.classList)!=null&&n.contains("thecircle-selection-popover")||(i=a.classList)!=null&&i.contains("thecircle-result-panel")||(o=a.classList)!=null&&o.contains("thecircle-menu")||(r=a.classList)!=null&&r.contains("thecircle-toast")))return;e&&clearTimeout(e),e=window.setTimeout(()=>{const a=window.getSelection(),l=(a==null?void 0:a.toString().trim())||"";if(l&&a&&a.rangeCount>0){const p=a.getRangeAt(0).getBoundingClientRect();this.currentSelectedText=l;const y=this.config.popoverPosition||"above";this.selectionPopover.show(p,{onTranslate:()=>this.handleSelectionTranslate()},y)}else this.selectionPopover.hide(),this.currentSelectedText=""},10)}),document.addEventListener("mousedown",t=>{var n,i,o,r,a;const s=t.composedPath();for(const l of s)if(l instanceof HTMLElement&&((n=l.classList)!=null&&n.contains("thecircle-selection-popover")||(i=l.classList)!=null&&i.contains("thecircle-result-panel")||(o=l.classList)!=null&&o.contains("thecircle-menu")||(r=l.classList)!=null&&r.contains("thecircle-toast")))return;(a=window.getSelection())!=null&&a.toString().trim()||this.selectionPopover.hide()})}async handleSelectionTranslate(){if(!this.currentSelectedText)return;const e=this.selectionMenuItems.find(o=>o.action==="translate");if(!e){this.showToast("翻译功能未配置","error");return}this.selectionPopover.hide(),this.menuActions.setSelectedText(this.currentSelectedText);const t=window.getSelection();let s=null;t&&t.rangeCount>0&&(s=t.getRangeAt(0).getBoundingClientRect()),s?s.left+s.width/2:window.innerWidth/2,s?s.bottom+20:window.innerHeight/2,this.radialMenu.setSelectionInfo(s),this.radialMenu.showResult(e.label,"",{isLoading:!0,originalText:this.currentSelectedText,type:"translate"});const n=this.config.useStreaming?(o,r)=>{this.radialMenu.streamUpdate(o,r)}:void 0,i=await this.menuActions.execute(e,n);i.type==="error"?this.radialMenu.showResult("错误",i.result||"未知错误"):i.type==="ai"&&this.radialMenu.updateResult(i.result||"")}setupKeyboardShortcut(){const e=new Set;document.addEventListener("keydown",t=>{if(e.add(t.key),this.config.shortcut.startsWith("Double+")){const s=this.config.shortcut.slice(7);if(this.matchDoubleTapKey(t.key,s)){const n=Date.now();this.lastKey===t.key&&n-this.lastKeyTime<this.DOUBLE_TAP_DELAY?(t.preventDefault(),this.showMenu(),this.lastKeyTime=0,this.lastKey=""):(this.lastKeyTime=n,this.lastKey=t.key)}}else this.matchShortcut(t,this.config.shortcut)&&(t.preventDefault(),this.showMenu())}),document.addEventListener("keyup",t=>{e.delete(t.key)}),window.addEventListener("blur",()=>{e.clear()})}matchDoubleTapKey(e,t){return({Control:["Control","ControlLeft","ControlRight"],Shift:["Shift","ShiftLeft","ShiftRight"],Alt:["Alt","AltLeft","AltRight"],Meta:["Meta","MetaLeft","MetaRight"],Space:[" ","Space"],Tab:["Tab"]}[t]||[t]).includes(e)||e.toLowerCase()===t.toLowerCase()}matchShortcut(e,t){if(!e.key)return!1;const s=t.split("+"),n=s[s.length-1],i=s.includes("Ctrl"),o=s.includes("Alt"),r=s.includes("Shift");return(n==="Space"?e.key===" ":e.key.toUpperCase()===n.toUpperCase())&&(e.ctrlKey||e.metaKey)===i&&e.altKey===o&&e.shiftKey===r}setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,s)=>(e.type==="TOGGLE_MENU"&&(this.showMenu(),s({success:!0})),!0))}showMenu(){this.selectionPopover.hide();const e=this.globalMenuItems,t=window.innerWidth/2,s=window.innerHeight/2;this.radialMenu.setSelectionInfo(null),this.radialMenu.show(t,s,e,async n=>{await this.handleMenuAction(n)})}async handleMenuAction(e){var s;if(["translate","summarize","explain","rewrite","codeExplain","summarizePage"].includes(e.action)){this.radialMenu.showResult(e.label,"",{isLoading:!0,originalText:this.currentSelectedText||((s=window.getSelection())==null?void 0:s.toString())||"",type:e.action==="translate"?"translate":"general"});const n=this.config.useStreaming?(o,r)=>{this.radialMenu.streamUpdate(o,r)}:void 0,i=await this.menuActions.execute(e,n);i.type==="error"?this.radialMenu.showResult("错误",i.result||"未知错误"):i.type==="ai"&&this.radialMenu.updateResult(i.result||"")}else{const n=await this.menuActions.execute(e);n.type==="error"?this.showToast(n.result||"未知错误","error"):n.type==="success"?this.showToast(n.result||"操作成功","success"):n.type==="info"&&this.showToast(n.result||"","info")}}getToastIcon(e){return{success:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>`,error:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>`,warning:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>`,info:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>`}[e]}showToast(e,t="info"){const s=document.createElement("div"),n={success:"thecircle-toast-success",error:"thecircle-toast-error",warning:"thecircle-toast-warning",info:"thecircle-toast-info"}[t];if(s.className=`thecircle-toast ${n}`,this.activeToasts.length>=this.MAX_TOASTS){const l=this.activeToasts.shift();l&&(clearTimeout(l.timeoutId),w(l.element))}const i=this.activeToasts.length;s.style.bottom=`${24+i*50}px`,s.setAttribute("data-index",String(i));const o=document.createElement("div");o.className="thecircle-toast-icon",o.innerHTML=this.getToastIcon(t);const r=document.createElement("span");r.textContent=e,s.appendChild(o),s.appendChild(r),L(s);const a=window.setTimeout(()=>{s.classList.add("animate-[thecircle-toast-out_0.2s_ease-out_forwards]","thecircle-toast-exit"),setTimeout(()=>{w(s),this.activeToasts=this.activeToasts.filter(l=>l.element!==s)},200)},3e3);this.activeToasts.push({element:s,timeoutId:a})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>new q):new q})();
